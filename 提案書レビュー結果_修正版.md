# 提案書レビュー結果（修正版）

**レビュー日**: 2025-12-09
**レビュー対象**: 提案_v0.21(abeセルフレビュー).pdf
**レビュー観点**: GenU標準機能・AWS標準機能との整合性、開発スコープの妥当性

## 前提条件

1. **顧客RFP要件**: 手作りデータパイプライン（Step Functions + Textract + カスタムチャンキング）が要求されている
2. **スタート地点**: GenU V1（OpenSearch Serverless使用、マルチテナント機能なし）
3. **今回の提案内容**: Aurora PostgreSQL化 + マルチテナント（部門）管理機能の追加
4. **部門フィルタリング方式**: RLS（Row Level Security）は実装せず、**Bedrock Knowledge Baseのfilterパラメータで制御**

---

## 修正が必要な箇所（一覧表）

| ページ | 現状の文章 | 修正後の文章 | 修正理由・説明 |
|--------|-----------|-------------|--------------|
| 6ページ<br>「データ前処理パイプライン」セクション | **データ前処理パイプライン (Step Functions)**<br>➢ S3トリガー起動: S3へのファイルアップロードを契機に起動するEventBridge ルールと Step Functions ステートマシンの構築。<br>➢ Textract 統合: PDF/画像に対しStartDocumentAnalysis APIを実行し、非同期でテキスト・表データを抽出するLambdaの実装。<br>➢ チャンク分割・埋め込み: LangChain等のライブラリを用い、ドキュメント構造（章・節）を考慮したチャンク分割と、Bedrock Titan/Cohere モデルによるベクトル化処理の実装。 | **データ前処理パイプライン (Step Functions)**<br>➢ S3トリガー起動: S3へのファイルアップロードを契機に起動するEventBridge ルールと Step Functions ステートマシンの構築。<br>➢ Textract 統合: PDF/画像に対しStartDocumentAnalysis APIを実行し、非同期でテキスト・表データを抽出するLambdaの実装。<br>➢ チャンク分割・埋め込み・Aurora格納: LangChain等のライブラリを用い、ドキュメント構造（章・節）を考慮したチャンク分割と、Bedrock Embeddings APIによるベクトル化、**部門メタデータ（department）付与の上でAurora PostgreSQLへのINSERT処理**を実装。<br>➢ **Bedrock Knowledge Base連携**: Aurora PostgreSQLをBedrock Knowledge Baseのデータソースとして登録し、Retrieve API経由で検索できるよう設定。部門フィルタリングは、Bedrock Retrieve API呼び出し時にfilterパラメータ（metadata.department = 'xxx'）を渡すことで実現。 | **カスタムパイプラインとBedrock KBの連携を明示**<br>• 顧客RFP要件として手作りパイプラインが必要なため、Step Functions実装は正当。<br>• 最終的なベクトル格納先はAurora PostgreSQLであり、そこからBedrock Knowledge BaseがRetrieve APIで検索する構成を明示すべき。<br>• **開発要素**:<br>  1. カスタムパイプライン実装（Step Functions + Lambda）<br>  2. Auroraスキーマ設計（Bedrock KB仕様準拠 + 部門メタデータ拡張）<br>  3. 部門メタデータの付与ロジック（パイプライン内）<br>  4. Bedrock KBとのデータソース連携設定<br>  5. Lambda（PredictStream）でBedrockのfilterパラメータに部門条件を渡す実装<br>• GenU V1（OpenSearch）からの変更点として、Aurora PostgreSQL採用による開発が必要。 |
| 6ページ<br>「Aurora PostgreSQL実装」セクション | **Aurora PostgreSQL (pgvector) の実装**<br>➢ DBスキーマ設計: ドキュメント本文、ベクトルデータに加え、metadata (JSONB型) カラムを定義し、テナントIDや属性情報を柔軟に格納できるテーブル設計。<br>➢ HNSWインデックス最適化: ベクトル検索の速度と精度のバランスを取るため、m 値や ef_construction パラメータを調整してインデックスを作成。<br>➢ RLS (Row Level Security) ポリシー適用: DBユーザーに関わらず、セッション変数 app.current_tenant とテーブル内のtenant_id が一致する場合のみ SELECT 可能とするSQLポリシーを適用。 | **Aurora PostgreSQL (pgvector) の実装**<br>➢ DBスキーマ設計: **Bedrock Knowledge Base仕様に準拠したテーブル構造**（id, chunks, embedding, metadata）を設計。metadata (JSONB型) に部門ID（department）やドキュメント属性を格納する拡張実装。<br>➢ HNSWインデックス最適化: pgvector拡張のHNSWインデックスを作成し、m値やef_constructionパラメータをチューニング。**Bedrock Retrieve APIからの検索クエリに最適化**。<br>➢ **部門フィルタリング実装（アプリケーション層）**: <br>  • Lambda関数（PredictStream）でJWTから部門情報（custom:department）を抽出<br>  • Bedrock Retrieve API呼び出し時に`retrievalConfiguration.vectorSearchConfiguration.filter`パラメータとして部門条件を渡す<br>  • フィルタ形式: `{"equals": {"key": "department", "value": "engineering"}}`<br>  • **RLS（Row Level Security）は実装しない**（Bedrock側のfilter機能で制御するため） | **Bedrock Knowledge Baseのfilter機能で部門制御**<br>• Aurora PostgreSQLは**Bedrock Knowledge Baseのデータソース**として機能するため、Bedrock仕様に準拠したスキーマ設計が必要。<br>• **部門フィルタリングの実装方式**:<br>  - DB層（RLS）ではなく、**アプリケーション層（Lambda）でBedrock APIのfilterパラメータを使用**<br>  - この方式の利点:<br>    1. Bedrock Knowledge Baseの標準機能を活用（クラウドネイティブ）<br>    2. RLS実装・管理の複雑性を回避<br>    3. Bedrock側でフィルタリングされるため、パフォーマンスが良い<br>    4. 将来的にBedrock以外のベクトルDBへの移行も容易<br>• **開発要素の詳細化**:<br>  1. Bedrock KB仕様準拠のスキーマ設計・構築<br>  2. 部門メタデータをmetadataカラムに格納する仕組み<br>  3. Lambda（PredictStream等）でBedrockのfilterパラメータに部門条件を渡す実装<br>  4. フロントエンド（React）からJWT経由で部門情報を取得する実装<br>• GenU V1のOpenSearch ServerlessからAurora PostgreSQLへの変更は大きな開発要素。<br>• **RLSの記載は削除すべき**（今回の提案では実装しない）。 |
| 5ページ<br>「既存APIの改修」部分 | **GenU標準APIのマルチテナント拡張**<br>➢ 既存APIの改修 (Chat/RAG): GenUが提供する POST /chat や POST /rag 等のLambda関数に対し、Bedrock呼び出し時に filter パラメータ（テナントID一致条件）を強制的に付与するロジックを追加。 | **GenU標準APIのマルチテナント拡張**<br>➢ 既存APIの改修 (Chat/RAG): GenUが提供する POST /predict-stream（Lambda関数: PredictStream）に対し、以下の拡張を実施:<br>  • **JWT解析処理の追加**: リクエストヘッダーからJWTを取得し、custom:department属性を抽出<br>  • **Bedrock Retrieve API呼び出し時のfilter付与**: 抽出した部門情報を`retrievalConfiguration.vectorSearchConfiguration.filter`パラメータとして渡す<br>  • **エラーハンドリング**: 部門情報が取得できない場合のフォールバック処理（デフォルト部門設定またはエラー返却）<br>➢ インターフェース維持: フロントエンド（React）との通信仕様（I/F）は極力変更せず、バックエンド側で認証情報から部門を自動判定することで、画面側の改修工数を抑制。 | **具体的なLambda関数名と実装内容を明示**<br>• GenU V1では部門の概念がないため、Lambda関数の拡張が必要。<br>• **開発要素の詳細化**:<br>  1. PredictStream Lambda関数の拡張<br>  2. JWT解析ライブラリの追加（jsonwebtoken等）<br>  3. custom:department属性の取得処理<br>  4. Bedrock Retrieve APIのfilterパラメータ構築ロジック<br>  5. 部門情報が取得できない場合のエラーハンドリング<br>• 提案書の表現を具体的な関数名と処理内容に修正すべき。 |
| 5ページ<br>「Entra ID連携」部分 | **LLMゲートウェイ (Tenant Resolver) の実装**<br>➢ Entra ID連携 (Auth): GenU標準のCognito Authorizerの前段または内部ロジックに、Entra ID発行のJWT検証プロセスを追加実装（署名・期限・Issuer確認）。<br>➢ テナント解決ロジック: JWT内の groups (セキュリティグループ) を解析し、DynamoDB上のマッピング定義を参照してtenant_id を特定する「前処理ロジック」を既存Lambdaに追加。 | **認証基盤とマルチテナント解決の実装**<br>➢ Entra ID連携 (Auth): **Cognito User PoolとEntra IDをSAML 2.0/OIDC連携により統合**。以下の設定・開発を実施:<br>  • Cognito User PoolへのSAML IDプロバイダー追加設定<br>  • 属性マッピング設定（Entra IDのgroups → Cognito custom:department）<br>  • カスタム属性（custom:department）の定義<br>  • **GenU V1はCognito単体認証のため、SAML連携設定が新規開発要素**<br>➢ 部門情報取得: <br>  • Lambda関数（GetUserDepartment等）でJWTからcustom:department属性を取得するAPI実装<br>  • フロントエンド（React）から呼び出し可能なREST APIとして提供<br>  • DynamoDBへのマッピング定義管理（groups → department の紐付け）は**オプション機能**として提案（PH1ではcustom:department属性を直接使用することを推奨） | **V1との差分とSAML連携の具体的実装を明示**<br>• GenU V1はCognito単体でユーザー管理を行っており、Entra ID連携機能はありません。<br>• **開発要素**:<br>  1. Cognito User PoolへのSAML IDプロバイダー追加設定<br>  2. 属性マッピング設定（Entra IDのgroups → Cognito custom:department）<br>  3. カスタム属性（custom:department）の定義<br>  4. Lambda（GetUserDepartment等）でJWTから部門情報を抽出するAPI実装<br>  5. フロントエンドからの部門情報取得処理<br>• JWT検証自体はCognitoが行うため、「JWT検証プロセスを追加実装」という表現は誤解を招く。<br>• DynamoDBでのマッピング管理は複雑性を増すため、custom:department属性を直接使用する方式を推奨。<br>• 提案書の表現を「SAML連携設定と属性マッピング実装」に修正すべき。 |
| 13ページ<br>「検索機能詳細」 | （「参照元の表示」「参照元へのリンク」「検索結果のプレビュー」「関連性スコアの表示」について、対応方針が記載されていない） | **以下は GenU標準機能で既に提供**:<br>• 参照元の表示：Bedrock Retrieve APIの`retrievedReferences`から取得した出典情報（ファイル名、チャンク内容）を表示<br>• 検索結果のプレビュー：取得されたチャンク内容（`content.text`）を標準で表示<br>• 関連性スコアの表示：Bedrock APIが返す`score`値を表示<br><br>**追加開発が必要**:<br>• 参照元へのリンク：S3/Box上の元ドキュメントへのリンク生成ロジック（メタデータからパス構築）<br>• Aurora PostgreSQL対応：V1（OpenSearch）からの移行に伴い、メタデータ構造の調整が必要<br>• 部門フィルタリング結果の表示：ユーザーの所属部門のみのドキュメントが検索されることを明示する表示 | **GenU標準機能と追加開発を区別**<br>• GenU V1で既に実装されている機能:<br>  - Bedrock Retrieve APIレスポンスの表示（出典、プレビュー、スコア）<br>  - Markdown.tsx、ChatMessage.tsxでの引用表示<br>  - retrievedReferencesの標準表示<br>• **追加開発要素**:<br>  1. Aurora PostgreSQL化に伴うメタデータ構造の調整<br>  2. Boxや社内ストレージへの直接リンク生成（GenU標準はS3前提）<br>  3. 部門によるフィルタリング結果の表示調整<br>  4. 「あなたの部門: Engineering」などの表示追加<br>• 標準機能を「追加開発」と誤認しないよう、提案書で明確に区別すべき。 |
| 7ページ<br>「管理画面UI開発」 | **管理画面 UI (React/SPA) の開発**<br>➢ システム管理者機能:<br>  • テナント管理（新規作成、論理削除、設定変更）<br>  • テナントごとのクォータ設定（DynamoDBへの閾値書き込み）<br>➢ 部門管理者機能:<br>  • ユーザー管理（Entra IDグループへの招待メール送信トリガー、または管理DBへの紐付け登録）<br>  • ドキュメント管理（S3へのアップロード、インデックス削除リクエスト、処理ステータス確認一覧） | **管理画面 UI (React/SPA) の開発**<br>➢ システム管理者機能:<br>  • 部門（テナント）管理画面（新規作成、論理削除、設定変更）<br>  • 部門ごとのクォータ設定画面（DynamoDBへの閾値書き込み）<br>  • **GenU V1にはマルチテナント管理機能がないため、新規開発が必要**<br>➢ 部門管理者機能:<br>  • ユーザー管理画面（Cognito User Poolへのユーザー追加、custom:department属性の設定、一覧表示）<br>  • ドキュメント管理画面（S3/Boxへのアップロードトリガー、Step Functions実行状況確認、インジェストエラー通知、処理ステータス一覧）<br>  • **GenU V1は個人利用想定のため、部門管理機能は新規開発**<br>➢ 画面修正: GenU標準画面（React/TypeScript）をベースに、以下の変更を実施:<br>  • ロゴ適用、カラーテーマ変更<br>  • 免責事項モーダルの追加<br>  • 部門表示の追加（ヘッダーに「部門: Engineering」等を表示）<br>  • GenU標準UIコンポーネント（InputChatContent、ChatMessage、Select等）は再利用 | **V1との差分とGenU標準UIの活用を明示**<br>• GenU V1の特徴:<br>  - マルチテナント機能なし（単一ユーザー・単一データセット想定）<br>  - 管理画面なし（AWSコンソールで運用）<br>  - フロントエンドはReact/TypeScript/Viteで構築済み<br>• **開発要素**:<br>  1. マルチテナント（部門）管理画面の新規開発<br>  2. ユーザー・部門紐付け管理画面の新規開発<br>  3. ドキュメント管理・インジェストステータス表示画面<br>  4. Step Functions実行状況の取得・表示機能<br>  5. GenU標準UIコンポーネント（InputChatContent、ChatMessage等）は再利用<br>  6. 部門表示の追加（ヘッダー等）<br>• 提案書に「GenU V1にはマルチテナント管理機能がないため、全面的な管理画面開発が必要」と明記すべき。<br>• ただし、GenU標準のReactコンポーネントは活用できるため、ゼロからの開発ではない点も記載すべき。 |
| 11ページ<br>「ログ管理」 | **ログ管理**: ファイルアップロード履歴、検索履歴、ユーザー操作ログ、ログエクスポート<br>【標準機能活用】CloudTrail および アプリケーションログ（S3/CloudWatch）への出力設定を行います。エクスポートはAWSコンソールまたはAthena経由での運用とします。 | **ログ管理**: ファイルアップロード履歴、検索履歴、ユーザー操作ログ、ログエクスポート<br>**GenU標準機能を活用**:<br>• 会話履歴：DynamoDBに保存済み（GenU標準）<br>• アプリケーションログ：CloudWatch Logsに出力済み（GenU標準）<br>• API呼び出し履歴：CloudTrailで記録済み（AWS標準）<br><br>**追加開発が必要**:<br>• ファイルアップロード履歴：カスタムパイプライン（Step Functions）の実行履歴をDynamoDB/CloudWatchに記録<br>• 部門別ログ集計：部門IDでフィルタリングした検索履歴・アップロード履歴の集計機能<br>• 監査ログ強化：以下の情報を構造化ログとして記録<br>  - 誰が（User ID、Email）<br>  - どの部門の（Department）<br>  - どのドキュメントに（Document ID、File Name）<br>  - いつ（Timestamp）<br>  - 何をしたか（Action: Search, Upload, Delete等）<br>• ログエクスポート機能：AWSコンソールまたはAthena経由での運用 | **標準機能と追加開発を明確化**<br>• GenU V1で既に提供されている機能:<br>  - DynamoDBへの会話履歴保存<br>  - CloudWatch Logsへのアプリケーションログ出力<br>  - CloudTrailによるAPI呼び出し履歴<br>• **追加開発要素**:<br>  1. カスタムパイプライン（Step Functions）のステータス・履歴記録<br>  2. 部門別のログ集計・フィルタリング機能<br>  3. 監査要件に対応した構造化ログ（User-Department-Document-Action紐付け）<br>  4. Aurora PostgreSQLへのアクセスログ（RDS Data API経由）<br>  5. ログのCloudWatch Logs Insightsでのクエリ対応<br>• V1からの変更により、ログ構造の拡張が必要な点を明示すべき。<br>• 特にマルチテナント（部門）対応により、すべてのログに部門情報を付与する必要がある。 |

---

## 総括

### 提案書の評価

前提条件を踏まえると、**提案書の開発内容は概ね妥当**です。ただし、以下の点を明確化・修正すべきです。

### 1. 顧客RFP要件との対応（提案内容は妥当）

- **手作りデータパイプライン要件** → Step Functions + Textract + カスタムチャンキング実装は必要
- **Aurora PostgreSQL採用** → スキーマ設計、Bedrock KB連携の開発が必要
- **マルチテナント（部門）管理** → 管理画面開発、部門フィルタリング実装が必要

### 2. GenU V1との差分を明示すべき点

| 項目 | GenU V1 | 今回の提案（V2） | 開発要素 |
|------|---------|-----------------|----------|
| ベクトルDB | OpenSearch Serverless | **Aurora PostgreSQL** | スキーマ設計、マイグレーション、Bedrock KB連携 |
| マルチテナント | なし | **部門管理機能** | 管理画面、部門フィルタリング（Bedrock filter） |
| 認証 | Cognito単体 | **Cognito + Entra ID SAML連携** | SAML設定、属性マッピング、custom:department |
| データ投入 | 手動またはシンプルなスクリプト | **Step Functions パイプライン** | Textract統合、カスタムチャンキング、メタデータ付与 |
| ログ管理 | 基本的なログ出力 | **部門別ログ集計、監査ログ** | 構造化ログ、部門情報付与、集計機能 |

### 3. 部門フィルタリングの実装方式（重要な修正点）

**提案書の現状**: RLS（Row Level Security）の実装を記載

**修正後**: RLS実装は行わず、**Bedrock Knowledge Baseのfilterパラメータで制御**

#### 実装方式の詳細

```typescript
// Lambda関数（PredictStream）での実装イメージ
const department = extractDepartmentFromJWT(event.headers.Authorization);

const bedrockRequest = {
  knowledgeBaseId: 'RCGCTTKSW0',
  retrievalQuery: { text: userQuery },
  retrievalConfiguration: {
    vectorSearchConfiguration: {
      filter: {
        equals: {
          key: 'department',
          value: department  // 'engineering' or 'sales'
        }
      }
    }
  }
};

const response = await bedrockClient.retrieve(bedrockRequest);
```

#### この方式の利点

1. **Bedrock Knowledge Baseの標準機能を活用**（クラウドネイティブなアプローチ）
2. **RLS実装・管理の複雑性を回避**（DB層の変更が不要）
3. **Bedrock側でフィルタリングされるため、パフォーマンスが良い**
4. **将来的なベクトルDB変更にも柔軟に対応可能**

### 4. 明確化が必要な技術アーキテクチャ

```
[ユーザー（ブラウザ）]
  ↓ HTTPS
[CloudFront + ALB]
  ↓
[Fargate (React/Node.js)]
  ↓ JWT (custom:department)
[Lambda: PredictStream]
  ↓ Bedrock Retrieve API (filter: department=xxx)
[Bedrock Knowledge Base]
  ↓ データソース接続
[Aurora PostgreSQL (pgvector)]
  ↑ INSERT (カスタムパイプライン)
[Step Functions]
  ↑ S3イベント
[S3バケット（ドキュメント格納）]
```

**重要な接続ポイント**:
- Lambda → Bedrock KB: `filter`パラメータで部門制御
- Bedrock KB → Aurora: データソース連携（Bedrock仕様準拠のスキーマ）
- Step Functions → Aurora: カスタムパイプラインでベクトル＋メタデータ格納

### 5. 提案書で修正・追記すべき具体的なページ

1. **6ページ「Aurora PostgreSQL実装」**: RLSの記載を削除し、Bedrock filterによる制御を記載
2. **6ページ「データ前処理パイプライン」**: Aurora格納とBedrock KB連携を明示
3. **5ページ「既存APIの改修」**: 具体的なLambda関数名（PredictStream）と実装内容を記載
4. **5ページ「Entra ID連携」**: SAML連携設定であることを明示、JWT検証の追加実装という誤解を招く表現を削除
5. **全体**: GenU V1との差分を明示し、「V1からの変更による開発要素」を整理

### 6. 開発工数の見積もりに影響する点

**工数削減要素**:
- RLS実装が不要になることで、DB設計・実装・テストの工数削減
- GenU標準UIコンポーネントの再利用により、フロントエンド開発工数削減

**工数増加要素**:
- カスタムデータパイプライン（Step Functions）の実装
- Aurora PostgreSQL化に伴うスキーマ設計・マイグレーション
- マルチテナント管理画面の全面開発
- Bedrock KB連携の設定・テスト

**総合評価**: 提案書の開発スコープは妥当だが、上記の修正により、より正確な工数見積もりが可能になる。

---

## 推奨アクション

1. **提案書の修正**: 上記の修正表に基づき、該当ページを更新
2. **技術アーキテクチャ図の追加**: カスタムパイプライン → Aurora → Bedrock KB の連携フローを図示
3. **GenU V1との差分表の追加**: OpenSearchからAurora PostgreSQLへの変更点を明示
4. **部門フィルタリング方式の明確化**: RLS削除、Bedrock filter採用の理由を記載
5. **開発スコープの再整理**: 「標準機能活用」「設定のみ」「追加開発」を明確に区別

---

**レビュー完了日**: 2025-12-09
**レビュアー**: Claude Code
**最終更新**: v1.1
