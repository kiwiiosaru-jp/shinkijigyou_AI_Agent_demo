flowchart TB
  subgraph Client ["Client / Edge"]
    UI["Browser (GenU Web UI)"]
    CF["Amazon CloudFront"]
    S3UI["S3 Static Hosting (GenU Web)"]
  end

  subgraph API ["API & Security (Routing / LLM Gateway)"]
    WAF["WAF WebACL"]
    RET["POST /retrieval/search (API Gateway REST)"]
    LLM["POST /llm/invoke (API Gateway REST)"]
  end

  subgraph Lambda ["Application Layer (Lambda)"]
    RouterFn["Lambda: retrieval router"]
    AdapterKb["Lambda: RAG Retriever (KB)"]
    AdapterKendra["Lambda: RAG Retriever (Kendra)"]
    LlmFn["Lambda: llm gateway"]
  end

  subgraph Data ["Data Plane (RAG)"]
    DDB["DynamoDB router table"]
    S3Docs["S3 doc bucket"]
    AOSS["AOSS collection"]
    KB["Bedrock Knowledge Base"]
    Kendra["Amazon Kendra Index"]
  end

  subgraph Logs ["Audit / Observability"]
    FHRet["Kinesis Firehose (retrieval)"]
    FHLlm["Kinesis Firehose (llm gateway)"]
    S3Logs["S3 audit bucket"]
    Glue["AWS Glue Tables"]
    Athena["Amazon Athena"]
    CWDash["CloudWatch Dashboard"]
  end

  %% Client / Edge flow
  UI -->|"HTTPS"| CF --> S3UI
  S3UI -->|"HTTPS / JSON"| RET
  S3UI -->|"HTTPS / JSON"| LLM

  %% WAF to APIs
  WAF -.-> RET
  WAF -.-> LLM

  %% API to Lambda
  RET --> RouterFn
  LLM --> LlmFn

  %% Router & Retrievers
  RouterFn -->|"read routing"| DDB
  RouterFn --> AdapterKb
  RouterFn --> AdapterKendra
  AdapterKb -->|"RAG Retriever (KB)"| KB
  KB -->|"vector search"| AOSS
  AdapterKendra -->|"RAG Retriever (Kendra)"| Kendra

  %% LLM Gateway
  LlmFn -->|"Guardrail & invoke"| KB

  %% Logging / Audit flow
  RouterFn --> FHRet
  LlmFn --> FHLlm
  FHRet --> S3Logs
  FHLlm --> S3Logs
  S3Logs --> Glue
  Glue --> Athena

  %% Dashboards
  CWDash --- RET
  CWDash --- LLM
  CWDash --- RouterFn
  CWDash --- LlmFn
