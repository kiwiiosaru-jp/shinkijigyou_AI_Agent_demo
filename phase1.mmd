flowchart LR
  %% ===== LAYER 1: Client / Edge (左端) =====
  subgraph Client["Client / Edge Layer"]
    direction TB
    GenUWeb["GenU Web UI<br/>(Browser + CloudFront + S3)"]
  end

  %% ===== LAYER 2: Public RAG API =====
  subgraph Api["Public RAG API (API Gateway + WAF)"]
    direction TB
    WAF["WAF WebACL"]
    APIGW["API Gateway (REST)<br/>POST /rag/query"]
    WAF -. "protects" .-> APIGW
  end

  GenUWeb -->|"HTTPS / JSON<br/>RAG request"| APIGW

  %% ===== LAYER 3: LLM Gateway & Retrieval Backend =====
  subgraph Core["LLM Gateway & Retrieval Backend (Lambda)"]
    direction TB
    LLMGW["Lambda: LLM gateway<br/>(Guardrails + RAG orchestration + LLM invoke)"]
    Router["Lambda: retrieval router"]
    RetrieverKB["Lambda: RAG Retriever (KB)"]
    RetrieverKendra["Lambda: RAG Retriever (Kendra)"]

    APIGW -->|"invoke /rag/query"| LLMGW
    LLMGW -->|"1. decide purpose<br/>2. build retrieval request"| Router
    Router -->|"routing info (KB)"| RetrieverKB
    Router -->|"routing info (Kendra)"| RetrieverKendra
  end

  %% ===== LAYER 4: Data Plane (RAG) =====
  subgraph Data["Data Plane (RAG)"]
    direction TB
    DDB["DynamoDB router table"]
    S3Docs["S3 doc bucket"]
    KB["Bedrock Knowledge Base"]
    Kendra["Amazon Kendra Index"]
    AOSS["AOSS Vector Collection"]

    Router -->|"read routing"| DDB
    RetrieverKB -->|"vector search"| KB --> AOSS
    RetrieverKendra -->|"full-text search"| Kendra
  end

  %% Retrieval results → LLM Gateway
  RetrieverKB -->|"retrieved chunks (KB)"| LLMGW
  RetrieverKendra -->|"retrieved chunks (Kendra)"| LLMGW

  %% LLM Gateway does guardrail + LLM call
  LLMGW -->|"question + retrieved context"| Guardrails["Guardrails + LLM invoke<br/>(Bedrock etc.)"]
  Guardrails -->|"final answer"| LLMGW
  LLMGW -->|"HTTP response"| APIGW --> GenUWeb

  %% ===== LAYER 5: Audit / Observability（なるべく下側に） =====
  subgraph Audit["Audit / Observability"]
    direction TB
    FH_LLM["Firehose: llm gateway logs"]
    FH_RET["Firehose: retrieval logs"]
    S3Audit["S3 audit bucket"]
    Glue["Glue tables"]
    Athena["Athena WorkGroup"]
    CWDash["CloudWatch Dashboard"]

    FH_LLM --> S3Audit
    FH_RET --> S3Audit
    S3Audit --> Glue --> Athena
  end

  %% 監査レイヤへの接続（下方向を意図）
  LLMGW --> FH_LLM
  Router --> FH_RET
  CWDash --- APIGW
  CWDash --- LLMGW
