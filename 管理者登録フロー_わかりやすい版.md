# マルチテナント認証・認可システム - 管理者登録フロー（わかりやすい版）

**作成日**: 2025-12-11
**対象システム**: 全社共通LLMゲートウェイ
**想定規模**: 8,000名 × 100ユースケース

**アーキテクチャ方針**:
- ✅ **DynamoDB 不使用**（S3 JSON ファイル方式）
- ✅ **Cognito 事前登録不要**（初回ログイン時に自動作成）
- ✅ **Cognito 招待メール不要**（業務メールで通知）

---

## 📋 推奨フロー（全体像）

### システム管理者の操作

```
1. 管理画面で tanaka@isuzu.co.jp を Admin-RAG に登録
    ↓
2. システムが S3 に JSON ファイル保存
   s3://pending-assignments/tanaka@isuzu.co.jp.json
    ↓
3. 画面に「登録完了。田中さんにログインURLを共有してください。」と表示
    ↓
4. システム管理者が田中さんに業務メール送信
   （または Lambda が自動送信）

   件名: 全社共通LLMゲートウェイ - RAG管理者に登録しました
   本文:
     ログインURL: https://llm-gateway.isuzu.co.jp
     社内アカウント（Entra ID）でログインしてください
    ↓
5. 田中さんがメール受信
```

### 田中さん（部門管理者）の操作

```
1. メール受信「管理者に登録されました」
    ↓
2. メール内のURLをクリック
   https://llm-gateway.isuzu.co.jp
    ↓
3. ログイン画面で「Entra ID でログイン」ボタンをクリック
    ↓
4. Entra ID で認証
   - 既存のアカウント（tanaka@isuzu.co.jp）を使用
   - 既存のパスワードを使用
   - ❌ 新しいパスワードは不要
    ↓
5. 初回ログイン成功
    ↓
6. 【自動処理】Post Authentication Trigger が実行
   - S3 から tanaka@isuzu.co.jp.json を読み取り
   - Admin-RAG グループに自動追加
   - S3 から JSON ファイル削除
    ↓
7. 管理画面が表示される
   - 管理者権限あり
   - ユーザー管理メニューが表示される
    ↓
8. 完了！
```

---

## 🔄 データフロー図

### ステップ1: システム管理者が登録

```
[システム管理者]
    ↓ 管理画面で操作
[React 管理UI]
    ↓ POST /api/admin/assign-pending-group
[API Gateway]
    ↓ JWT検証（SystemAdmin権限確認）
[Lambda: AssignPendingGroup]
    ├─ Cognito AdminGetUser → UserNotFoundException
    │  （田中さんはまだログインしていない）
    └─ S3 PutObject
        └─ s3://pending-assignments/tanaka@isuzu.co.jp.json
            {
              "email": "tanaka@isuzu.co.jp",
              "groups": ["Admin-RAG"],
              "requestedBy": "system-admin@isuzu.co.jp",
              "requestedAt": "2025-12-11T10:00:00Z"
            }

[システム管理者]
    ↓ 業務メール送信
[田中さん]
    └─ メール受信
```

### ステップ2: 田中さんが初回ログイン

```
[田中さん]
    ↓ URLクリック: https://llm-gateway.isuzu.co.jp
[React ログイン画面]
    ↓ "Entra ID でログイン" ボタンクリック
[Cognito Hosted UI]
    ↓ SAML認証リクエスト
[Entra ID (Microsoft)]
    ├─ ユーザー認証
    └─ SAML Assertion 返却
        ↓
[Cognito User Pool]
    ├─ ユーザー作成: tanaka@isuzu.co.jp
    │   - email: tanaka@isuzu.co.jp
    │   - email_verified: true
    │   - identities: [{ providerName: "EntraID" }]
    └─ Post Authentication Trigger 実行
        ↓
[Lambda: PostAuthentication]
    ├─ S3 GetObject: tanaka@isuzu.co.jp.json
    │   → 発見！
    ├─ Cognito AdminAddUserToGroup
    │   → tanaka@isuzu.co.jp を Admin-RAG に追加
    └─ S3 DeleteObject: tanaka@isuzu.co.jp.json
        → 削除完了
        ↓
[Cognito User Pool]
    └─ tanaka@isuzu.co.jp
        └─ Groups: ["Admin-RAG"] ← 自動追加完了
        ↓
[JWT 発行]
    └─ cognito:groups: ["Admin-RAG"] を含む
        ↓
[React 管理画面]
    └─ 管理者権限で表示
```

---

## 📧 通知方法の選択肢

### オプション1: 手動メール送信（推奨・シンプル）

**メリット**:
- ✅ 追加開発不要
- ✅ 柔軟な説明が可能
- ✅ 業務メールなので確実

**デメリット**:
- ⚠️ 手動作業が必要

**メール例**:

```
From: システム管理者 <it-admin@isuzu.co.jp>
To: 田中太郎 <tanaka@isuzu.co.jp>
件名: 全社共通LLMゲートウェイ - RAG管理者に登録しました

田中さん

お疲れ様です。IT部門です。

あなたを全社共通LLMゲートウェイのRAG管理者に登録しました。
以下のURLからログインしてください。

■ログインURL
https://llm-gateway.isuzu.co.jp

■ログイン方法
1. 上記URLにアクセス
2. 「Entra ID でログイン」ボタンをクリック
3. 社内アカウント（tanaka@isuzu.co.jp）でログイン
   ※既存のパスワードを使用します（新しいパスワードは不要）

初回ログイン時に、自動的にRAG管理者権限が付与されます。

■管理者として実施できること
- RAGユースケースの一般ユーザー管理
- ユーザーの追加・削除
- ドキュメントのアップロード・管理

ご不明な点がございましたら、IT部門までお問い合わせください。

---
IT部門
it-admin@isuzu.co.jp
```

---

### オプション2: Lambda 自動メール送信（オプション）

**メリット**:
- ✅ 自動化
- ✅ 即座に通知
- ✅ 手動作業不要

**デメリット**:
- ⚠️ SES の設定が必要（送信ドメイン認証等）
- ⚠️ 開発コスト増加（+3人日程度）

**実装**:

```typescript
// Lambda: AssignPendingGroup の最後に追加
import { SESClient, SendEmailCommand } from '@aws-sdk/client-ses';

const ses = new SESClient({ region: 'ap-northeast-1' });

// S3 に保存した後、メール送信
if (process.env.SEND_NOTIFICATION === 'true') {
  await ses.send(new SendEmailCommand({
    Source: 'noreply@isuzu.co.jp',
    Destination: {
      ToAddresses: [email],
    },
    Message: {
      Subject: {
        Data: '全社共通LLMゲートウェイ - 管理者に登録されました',
      },
      Body: {
        Text: {
          Data: `
${email} 様

あなたを全社共通LLMゲートウェイの管理者に登録しました。

■ログインURL
https://llm-gateway.isuzu.co.jp

■ログイン方法
1. 上記URLにアクセス
2. 「Entra ID でログイン」ボタンをクリック
3. 社内アカウントでログイン

初回ログイン時に、自動的に管理者権限が付与されます。

※このメールは自動送信です。返信不要です。
          `,
        },
      },
    },
  }));

  console.log(`Notification email sent to ${email}`);
}
```

**管理画面UI**:

```tsx
// AdminRegistration.tsx
const [sendNotification, setSendNotification] = useState(true);

<div>
  <input
    type="checkbox"
    checked={sendNotification}
    onChange={e => setSendNotification(e.target.checked)}
  />
  <label>通知メールを自動送信する</label>
</div>
```

---

## 💻 画面イメージ

### 1. システム管理者の登録画面

```
┌─────────────────────────────────────────┐
│ 全社共通LLMゲートウェイ - 管理画面      │
├─────────────────────────────────────────┤
│                                         │
│  部門管理者の登録                       │
│                                         │
│  メールアドレス:                        │
│  ┌─────────────────────────────────┐   │
│  │ tanaka@isuzu.co.jp              │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ユースケース（複数選択可）:            │
│  ☑ RAG                                  │
│  ☐ Translation                          │
│  ☐ CodeGen                              │
│                                         │
│  ☑ 通知メールを送信する（オプション）   │
│                                         │
│         ┌───────────────┐              │
│         │ 登録する      │              │
│         └───────────────┘              │
│                                         │
└─────────────────────────────────────────┘
```

### 2. 登録完了メッセージ

```
┌─────────────────────────────────────────┐
│  ✅ 登録完了                             │
│                                         │
│  tanaka@isuzu.co.jp を                  │
│  Admin-RAG に登録しました。             │
│                                         │
│  対象者が初回ログイン時に、             │
│  自動的に管理者権限が付与されます。     │
│                                         │
│  ［オプション］                         │
│  以下のURLを田中さんに共有してください: │
│  https://llm-gateway.isuzu.co.jp        │
│                                         │
│         ┌───────────────┐              │
│         │ 閉じる        │              │
│         └───────────────┘              │
└─────────────────────────────────────────┘
```

### 3. 田中さんのログイン画面

```
┌─────────────────────────────────────────┐
│                                         │
│        全社共通LLMゲートウェイ          │
│                                         │
│         Generative AI Platform          │
│                                         │
│                                         │
│      ┌─────────────────────────────┐   │
│      │                             │   │
│      │  Entra ID でログイン       │   │
│      │                             │   │
│      └─────────────────────────────┘   │
│                                         │
│                                         │
│   ※社内アカウントでログインします      │
│                                         │
└─────────────────────────────────────────┘
```

### 4. 初回ログイン後の管理画面

```
┌─────────────────────────────────────────┐
│ 全社共通LLMゲートウェイ                 │  田中太郎 ▼
├─────────────────────────────────────────┤
│ ☰ メニュー                             │
│   ■ ホーム                             │
│   ■ RAGチャット                        │
│   ■ ユーザー管理 ← 管理者のみ表示      │
│   ■ ドキュメント管理 ← 管理者のみ表示  │
│   ■ 設定                               │
├─────────────────────────────────────────┤
│                                         │
│  ようこそ、田中さん                     │
│                                         │
│  あなたは RAG 管理者です                │
│                                         │
│  ■ 現在のユーザー数: 5名                │
│  ■ 登録済みドキュメント: 120件          │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ ユーザーを追加                 │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

---

## 🔐 重要ポイント

### ❌ Cognito 招待メールは送られません

| 項目 | 内容 |
|------|------|
| **理由** | ・Cognito にユーザーを事前作成していない<br>・SAML 連携でパスワード不要<br>・S3 に JSON ファイルを保存するだけ |
| **田中さんに必要な情報** | ・ログインURL: `https://llm-gateway.isuzu.co.jp`<br>・既存の Entra ID アカウント（既に知っている） |
| **新しいパスワードは必要？** | ❌ **不要**（Entra ID のパスワードを使用） |
| **Cognito のパスワードは？** | ❌ **不要**（SAML 連携なので Cognito パスワードは存在しない） |

### ✅ 初回ログイン時に自動で権限付与

| タイミング | 処理内容 |
|-----------|---------|
| **ログイン前** | S3 に `tanaka@isuzu.co.jp.json` が保存されている<br>Cognito に田中さんは存在しない |
| **ログイン時** | Entra ID で認証成功<br>Cognito User Pool にユーザー自動作成<br>Post Authentication Trigger 実行 |
| **ログイン直後** | Lambda が S3 から JSON 読み取り<br>`Admin-RAG` グループに自動追加<br>S3 から JSON 削除 |
| **ログイン完了** | JWT に `cognito:groups: ["Admin-RAG"]` が含まれる<br>管理画面が表示される |

---

## 🛠️ 技術実装詳細

### Lambda: AssignPendingGroup（簡略版）

```typescript
export const handler = async (event: APIGatewayProxyEvent) => {
  const { email, groups } = JSON.parse(event.body!);

  try {
    // ステップ1: Cognito でユーザー存在確認
    await cognito.send(new AdminGetUserCommand({
      UserPoolId: process.env.USER_POOL_ID!,
      Username: email,
    }));

    // ユーザーが既に存在 → 直接グループに追加
    for (const group of groups) {
      await cognito.send(new AdminAddUserToGroupCommand({
        UserPoolId: process.env.USER_POOL_ID!,
        Username: email,
        GroupName: group,
      }));
    }

    return {
      statusCode: 200,
      body: JSON.stringify({
        message: 'グループに追加しました',
        status: 'applied',
      }),
    };

  } catch (error: any) {
    if (error.name === 'UserNotFoundException') {
      // ステップ2: ユーザーが未ログイン → S3 に保存
      await s3.send(new PutObjectCommand({
        Bucket: process.env.PENDING_ASSIGNMENTS_BUCKET!,
        Key: `${email}.json`,
        Body: JSON.stringify({
          email,
          groups,
          requestedBy: event.requestContext.authorizer!.claims['cognito:username'],
          requestedAt: new Date().toISOString(),
        }),
        ContentType: 'application/json',
      }));

      return {
        statusCode: 200,
        body: JSON.stringify({
          message: '登録しました。初回ログイン時に自動適用されます。',
          status: 'pending',
        }),
      };
    }

    throw error;
  }
};
```

### Lambda: PostAuthentication（簡略版）

```typescript
export const handler = async (event: PostAuthenticationTriggerEvent) => {
  const email = event.request.userAttributes.email;

  try {
    // ステップ1: S3 から保留ファイル取得
    const response = await s3.send(new GetObjectCommand({
      Bucket: process.env.PENDING_ASSIGNMENTS_BUCKET!,
      Key: `${email}.json`,
    }));

    const data = JSON.parse(await response.Body!.transformToString());

    // ステップ2: グループに追加
    for (const group of data.groups) {
      await cognito.send(new AdminAddUserToGroupCommand({
        UserPoolId: event.userPoolId,
        Username: email,
        GroupName: group,
      }));
      console.log(`✅ Added ${email} to group ${group}`);
    }

    // ステップ3: S3 から削除
    await s3.send(new DeleteObjectCommand({
      Bucket: process.env.PENDING_ASSIGNMENTS_BUCKET!,
      Key: `${email}.json`,
    }));

    console.log(`✅ Removed pending assignment for ${email}`);

  } catch (error: any) {
    if (error.name === 'NoSuchKey') {
      // 保留なし（通常のログイン）
      console.log(`ℹ️ No pending assignment for ${email}`);
    } else {
      console.error(`❌ Error:`, error);
    }
  }

  // ログイン続行
  return event;
};
```

---

## 📊 使用サービス一覧

| サービス | 用途 | 開発要否 |
|---------|------|---------|
| **S3** | 保留中のグループ割り当て保存 | ✅ CDK実装 |
| **Cognito User Pool** | ユーザー・グループ管理 | ✅ CDK実装 |
| **Cognito Identity Pool** | IAM Role マッピング | ✅ CDK実装 |
| **Lambda (AssignPendingGroup)** | 登録処理 | ✅ TypeScript実装 |
| **Lambda (PostAuthentication)** | 自動グループ追加 | ✅ TypeScript実装 |
| **API Gateway** | REST API | ✅ CDK実装 |
| **Entra ID (SAML)** | 認証 | ❌ 顧客側設定 |
| **SES (オプション)** | メール送信 | △ オプション |

---

## 🎯 部門管理者が一般ユーザーを登録する場合

田中さん（部門管理者）が佐藤さん（一般ユーザー）を登録する場合も、**全く同じフロー**です。

### 違いは2点のみ

| 項目 | システム管理者 → 部門管理者 | 部門管理者 → 一般ユーザー |
|------|---------------------------|------------------------|
| **登録者** | システム管理者 | 部門管理者（田中さん） |
| **対象グループ** | `Admin-RAG` | `User-RAG` |

### 田中さんの操作（部門管理者として）

```
1. 管理画面で「ユーザー管理」メニューをクリック
    ↓
2. 「新規ユーザー追加」ボタンをクリック
    ↓
3. メールアドレス入力: sato@isuzu.co.jp
    ↓
4. 「追加」ボタンをクリック
    ↓
5. システムが S3 に JSON ファイル保存
   s3://pending-assignments/sato@isuzu.co.jp.json
    ↓
6. 画面に「登録完了」メッセージ表示
    ↓
7. 田中さんが佐藤さんに業務メール送信
   「RAGユースケースに登録しました。ログインしてください。」
    ↓
8. 佐藤さんがログイン → User-RAG グループに自動追加
```

---

## ✨ 利点まとめ

### シンプル

- ✅ Cognito にユーザーを事前作成しない
- ✅ パスワード管理不要（Entra ID のパスワードのみ）
- ✅ S3 JSON ファイルだけで保留管理
- ✅ DynamoDB 不要

### 低コスト

- ✅ S3 ストレージ: 月額 $0.01 程度
- ✅ Lambda 実行: 登録時のみ（1ユーザーあたり $0.0000002）
- ✅ Cognito: 月間アクティブユーザー 50,000 まで無料

### セキュア

- ✅ Entra ID の MFA がそのまま適用
- ✅ 社内の既存パスワードポリシーに準拠
- ✅ JWT に `cognito:groups` が含まれる（改ざん不可）

### ユーザーフレンドリー

- ✅ 新しいパスワードを覚える必要なし
- ✅ 既存の社内アカウントでログイン
- ✅ 初回ログイン時に自動で権限付与

---

## 📈 開発工数見積

| 開発要素 | 工数 |
|---------|------|
| **管理画面UI**（システム管理者用） | 10人日 |
| **管理画面UI**（部門管理者用） | 12人日 |
| **Lambda: AssignPendingGroup** | 5人日 |
| **Lambda: PostAuthentication** | 5人日 |
| **インフラ（CDK）**: S3, API Gateway, Cognito | 13人日 |
| **オプション: SES 自動メール送信** | +3人日 |

**合計**: **約45人日**（管理者登録機能のみ、自動メール送信なし）

---

## 🚀 次のステップ

このドキュメントで管理者登録フローの理解が深まったら、次は：

1. ✅ 一般ユーザーがRAGチャットを開始するフロー
2. ✅ ドキュメントアップロード＆インジェスト処理
3. ✅ 部門別フィルタリング実装詳細
4. ✅ モニタリング・ダッシュボード構築

---

**作成者**: SI開発チーム
**最終更新**: 2025-12-11
**バージョン**: 3.0（わかりやすい版）
