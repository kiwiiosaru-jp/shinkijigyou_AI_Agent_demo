# マルチテナント認証・認可システム - 管理者登録フロー（詳細版・表形式）

**作成日**: 2025-12-11
**対象システム**: 全社共通LLMゲートウェイ
**想定規模**: 8,000名 × 100ユースケース

**アーキテクチャ方針**:
- ✅ **DynamoDB 不使用**（S3 JSON ファイル方式）
- ✅ **Cognito 事前登録不要**（初回ログイン時に自動作成）
- ✅ **Cognito 招待メール不要**（業務メールで通知）

---

## 📋 推奨フロー（全体像）

### システム管理者の操作

```
1. 管理画面で tanaka@isuzu.co.jp を Admin-RAG に登録
    ↓
2. システムが S3 に JSON ファイル保存
   s3://pending-assignments/tanaka@isuzu.co.jp.json
    ↓
3. 画面に「登録完了。田中さんにログインURLを共有してください。」と表示
    ↓
4. システム管理者が田中さんに業務メール送信
   （または Lambda が自動送信）

   件名: 全社共通LLMゲートウェイ - RAG管理者に登録しました
   本文:
     ログインURL: https://llm-gateway.isuzu.co.jp
     社内アカウント（Entra ID）でログインしてください
    ↓
5. 田中さんがメール受信
```

### 田中さん（部門管理者）の操作

```
1. メール受信「管理者に登録されました」
    ↓
2. メール内のURLをクリック
   https://llm-gateway.isuzu.co.jp
    ↓
3. ログイン画面で「Entra ID でログイン」ボタンをクリック
    ↓
4. Entra ID で認証
   - 既存のアカウント（tanaka@isuzu.co.jp）を使用
   - 既存のパスワードを使用
   - ❌ 新しいパスワードは不要
    ↓
5. 初回ログイン成功
    ↓
6. 【自動処理】Post Authentication Trigger が実行
   - S3 から tanaka@isuzu.co.jp.json を読み取り
   - Admin-RAG グループに自動追加
   - S3 から JSON ファイル削除
    ↓
7. 管理画面が表示される
   - 管理者権限あり
   - ユーザー管理メニューが表示される
    ↓
8. 完了！
```

---

## 🔄 詳細処理フロー（表形式）

## ステップ1: システム管理者が部門管理者を登録

### 1-1. 管理画面で操作

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 1.1.1 | 管理画面でメールアドレス入力<br>`tanaka@isuzu.co.jp` | - | - | ✅ **開発必要** | **管理画面UI（React）**<br>- メールアドレス入力フォーム<br>- ユースケース選択 (Multi-Select)<br>  - ☑ RAG<br>  - ☐ Translation<br>  - ☐ CodeGen<br>- 登録ボタン |
| 1.1.2 | "登録する"ボタンクリック | - | - | ✅ **開発必要** | **フロントエンド実装**<br>- onClick イベントハンドラ<br>- バリデーション（メール形式チェック）<br>- API呼び出し処理 |

### 1-2. API Gateway → Lambda 実行

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 1.2.1 | POST `/api/admin/assign-pending-group`<br>リクエスト送信<br>Headers: `Authorization: Bearer {JWT}` | **API Gateway** | - | ✅ **開発必要** | **フロントエンド実装**<br>- Fetch API / Axios<br>- JWT 自動付与<br>- リクエストボディ構築<br>```json<br>{<br>  "email": "tanaka@isuzu.co.jp",<br>  "groups": ["Admin-RAG"]<br>}<br>``` |
| 1.2.2 | API Gateway で JWT 検証<br>システム管理者権限確認 | **API Gateway**<br>**Cognito Authorizer** | - | ✅ **開発必要** | **CDK実装**<br>- API Gateway 定義<br>- Cognito Authorizer 設定<br>- SystemAdmin グループのみアクセス許可 |
| 1.2.3 | Lambda 関数実行<br>`AssignPendingGroup` | **Lambda** | - | ✅ **開発必要** | **Lambda実装（TypeScript）**<br>- リクエスト受信<br>- 入力バリデーション<br>- システム管理者権限チェック |

### 1-3. Cognito でユーザー存在確認

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 1.3.1 | `AdminGetUser` API 呼び出し<br>ユーザーが Cognito に存在するか確認 | **Cognito User Pool** | - | ✅ **開発必要** | **Lambda実装**<br>- Cognito SDK 使用<br>```typescript<br>await cognito.send(<br>  new AdminGetUserCommand({<br>    UserPoolId,<br>    Username: email<br>  })<br>)<br>``` |
| 1.3.2 | **分岐判定**<br>- ケースA: ユーザーが存在<br>- ケースB: `UserNotFoundException` | **Cognito User Pool** | - | ✅ **開発必要** | **Lambda実装**<br>- try-catch による分岐処理 |

### 1-4. ケースA: ユーザーが既に存在する場合（直接グループ追加）

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 1.4.1 | `AdminAddUserToGroup` 実行<br>GroupName: `Admin-RAG` | **Cognito User Pool** | **User Pool 内部DB**<br>Groups → Admin-RAG → Members<br>`tanaka@isuzu.co.jp` 追加 | ✅ **開発必要** | **Lambda実装**<br>```typescript<br>for (const group of groups) {<br>  await cognito.send(<br>    new AdminAddUserToGroupCommand({<br>      UserPoolId,<br>      Username: email,<br>      GroupName: group<br>    })<br>  )<br>}<br>``` |
| 1.4.2 | レスポンス返却<br>`{ status: "applied" }` | - | - | ✅ **開発必要** | **Lambda実装**<br>- HTTP 200 レスポンス<br>- JSON形式<br>```json<br>{<br>  "message": "グループに追加しました",<br>  "status": "applied"<br>}<br>``` |
| 1.4.3 | 画面に完了メッセージ表示 | - | - | ✅ **開発必要** | **フロントエンド実装**<br>- レスポンス受信<br>- トースト通知表示 |

### 1-5. ケースB: ユーザーが未ログイン（S3 に保存）

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 1.5.1 | S3 バケットにJSONファイル作成<br>Key: `{email}.json` | **S3** | **S3バケット**<br>`s3://pending-assignments/`<br>`tanaka@isuzu.co.jp.json`<br>```json<br>{<br>  "email": "tanaka@isuzu.co.jp",<br>  "groups": ["Admin-RAG"],<br>  "requestedBy": "admin@isuzu.co.jp",<br>  "requestedAt": "2025-12-11T10:00:00Z"<br>}<br>``` | ✅ **開発必要** | **Lambda実装**<br>- S3 SDK 使用<br>```typescript<br>await s3.send(<br>  new PutObjectCommand({<br>    Bucket: bucketName,<br>    Key: `${email}.json`,<br>    Body: JSON.stringify({<br>      email,<br>      groups,<br>      requestedBy,<br>      requestedAt: new Date()<br>    }),<br>    ContentType: 'application/json'<br>  })<br>)<br>``` |
| 1.5.2 | レスポンス返却<br>`{ status: "pending" }` | - | - | ✅ **開発必要** | **Lambda実装**<br>- HTTP 200 レスポンス<br>```json<br>{<br>  "message": "登録しました。初回ログイン時に自動適用されます。",<br>  "status": "pending"<br>}<br>``` |
| 1.5.3 | 画面に登録完了メッセージ表示<br>「対象者が初回ログイン時に自動適用」 | - | - | ✅ **開発必要** | **フロントエンド実装**<br>- status="pending" 判定<br>- 専用メッセージ表示<br>- ログインURL表示 |

### 1-6. 通知メール送信（オプション）

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 1.6.1 | **オプション1: 手動メール送信**<br>システム管理者が業務メールで通知 | - | - | ❌ **開発不要** | **業務メール作成**<br>- 件名: 全社共通LLMゲートウェイ - RAG管理者に登録<br>- 本文: ログインURL案内 |
| 1.6.2 | **オプション2: 自動メール送信**<br>Lambda から SES で送信 | **Amazon SES** | - | △ **オプション開発** | **Lambda実装（+3人日）**<br>- SES SDK 使用<br>- メールテンプレート<br>- 送信ドメイン認証設定 |

---

## ステップ2: 部門管理者が初回ログイン

### 2-1. ブラウザでアプリURLにアクセス

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 2.1.1 | ブラウザで URL 入力<br>`https://llm-gateway.isuzu.co.jp` | **CloudFront**<br>**ALB**<br>**ECS (Fargate)** | - | ✅ **開発必要** | **React SPA（フロントエンド）**<br>- ログインページ表示<br>- Cognito Hosted UI へリダイレクト |
| 2.1.2 | Cognito Hosted UI 表示<br>"Entra ID でログイン" ボタン | **Cognito Hosted UI** | - | ❌ **設定のみ** | **Cognito設定**<br>- Hosted UI カスタマイズ（CSS）<br>- ロゴ・背景色変更 |

### 2-2. Entra ID 認証

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 2.2.1 | Cognito → Entra ID へリダイレクト<br>SAML 認証リクエスト | **Entra ID (Microsoft)**<br>**SAML 2.0** | - | ❌ **顧客側設定** | **設定作業のみ**<br>- Entra ID → Cognito SAML設定<br>- メタデータXML交換<br>- 属性マッピング設定 |
| 2.2.2 | Entra ID でユーザー認証<br>（MFA含む） | **Entra ID** | **Entra ID 内部DB** | ❌ **顧客側管理** | - |
| 2.2.3 | SAML Assertion 生成<br>Cognito へ返却 | **Entra ID** | - | ❌ **SAML標準** | - |

### 2-3. Cognito User Pool にユーザー作成

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 2.3.1 | SAML Assertion 受信<br>ユーザー情報抽出 | **Cognito User Pool** | - | ❌ **AWS標準機能** | - |
| 2.3.2 | User Pool にユーザー作成<br>Username: `tanaka@isuzu.co.jp` | **Cognito User Pool** | **User Pool 内部DB**<br>`Users` テーブル<br>- Username: tanaka@isuzu.co.jp<br>- email: tanaka@isuzu.co.jp<br>- email_verified: true<br>- identities: [{ providerName: "EntraID" }] | ❌ **AWS標準機能** | - |

### 2-4. Post Authentication Trigger 実行

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 2.4.1 | Lambda 関数実行<br>`PostAuthentication` | **Lambda**<br>**Cognito Trigger** | - | ✅ **開発必要** | **Lambda実装（TypeScript）**<br>- Cognito Trigger ハンドラ<br>- イベント受信 |
| 2.4.2 | S3 から保留ファイル取得<br>Key: `tanaka@isuzu.co.jp.json` | **S3** | **S3バケット** | ✅ **開発必要** | **Lambda実装**<br>```typescript<br>const response = await s3.send(<br>  new GetObjectCommand({<br>    Bucket: bucketName,<br>    Key: `${email}.json`<br>  })<br>)<br>const data = JSON.parse(<br>  await response.Body.transformToString()<br>)<br>``` |
| 2.4.3 | **分岐判定**<br>- ケースA: ファイルが存在<br>- ケースB: `NoSuchKey` エラー | **S3** | - | ✅ **開発必要** | **Lambda実装**<br>- try-catch エラーハンドリング<br>- ケースB: ログイン続行 |

### 2-5. Cognito グループに追加

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 2.5.1 | `AdminAddUserToGroup` 実行<br>GroupName: `Admin-RAG` | **Cognito User Pool** | **User Pool 内部DB**<br>Groups → Admin-RAG → Members<br>[`tanaka@isuzu.co.jp`] 追加 | ✅ **開発必要** | **Lambda実装**<br>```typescript<br>for (const group of groups) {<br>  await cognito.send(<br>    new AdminAddUserToGroupCommand({<br>      UserPoolId,<br>      Username: email,<br>      GroupName: group<br>    })<br>  )<br>}<br>``` |
| 2.5.2 | S3 からファイル削除<br>Key: `tanaka@isuzu.co.jp.json` | **S3** | **S3バケット**<br>（削除） | ✅ **開発必要** | **Lambda実装**<br>```typescript<br>await s3.send(<br>  new DeleteObjectCommand({<br>    Bucket: bucketName,<br>    Key: `${email}.json`<br>  })<br>)<br>``` |
| 2.5.3 | Lambda から Cognito へ制御返却<br>`return event` | - | - | ✅ **開発必要** | **Lambda実装**<br>- event オブジェクトそのまま返却<br>- ログイン続行 |

### 2-6. JWT 発行

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 2.6.1 | ID Token 発行<br>`cognito:groups: ["Admin-RAG"]` 含む | **Cognito User Pool** | - | ❌ **AWS標準機能** | - |
| 2.6.2 | Access Token, Refresh Token 発行 | **Cognito User Pool** | - | ❌ **AWS標準機能** | - |
| 2.6.3 | Authorization Code 返却<br>コールバックURLへリダイレクト | **Cognito OAuth 2.0** | - | ❌ **AWS標準機能** | - |

**ID Token 例**:
```json
{
  "sub": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "cognito:groups": ["Admin-RAG"],
  "email": "tanaka@isuzu.co.jp",
  "email_verified": true,
  "iss": "https://cognito-idp.ap-northeast-1.amazonaws.com/...",
  "exp": 1702303600
}
```

### 2-7. フロントエンドで Token 取得

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 2.7.1 | コールバックURL で Authorization Code 受信 | - | - | ✅ **開発必要** | **React実装**<br>- URL パラメータ解析<br>- `?code=xxx` 抽出 |
| 2.7.2 | Token エンドポイントへリクエスト<br>Code → Token 交換 | **Cognito Token Endpoint** | - | ✅ **開発必要** | **React実装**<br>```typescript<br>const response = await fetch(<br>  tokenEndpoint,<br>  {<br>    method: 'POST',<br>    body: new URLSearchParams({<br>      grant_type: 'authorization_code',<br>      code,<br>      client_id,<br>      redirect_uri<br>    })<br>  }<br>)<br>``` |
| 2.7.3 | Token を LocalStorage に保存 | - | **ブラウザ LocalStorage**<br>- idToken<br>- accessToken<br>- refreshToken | ✅ **開発必要** | **React実装**<br>```typescript<br>localStorage.setItem('idToken', idToken)<br>localStorage.setItem('accessToken', accessToken)<br>localStorage.setItem('refreshToken', refreshToken)<br>``` |
| 2.7.4 | ホーム画面へリダイレクト<br>管理画面表示 | - | - | ✅ **開発必要** | **React実装**<br>- `navigate('/')` 実行<br>- JWT から権限確認<br>- 管理者メニュー表示 |

---

## ステップ3: 部門管理者が一般ユーザーを登録

### 3-1. 管理画面にアクセス

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 3.1.1 | ホーム画面から「ユーザー管理」メニュークリック | - | - | ✅ **開発必要** | **React UI**<br>- サイドメニュー<br>- 権限に応じた表示制御<br>- `cognito:groups` から判定 |
| 3.1.2 | 管理画面で現在のユーザー一覧表示<br>`AdminListUsersInGroup` | **Cognito Identity Pool**<br>**Cognito User Pool** | - | ✅ **開発必要** | **React実装**<br>- Identity Pool から一時認証情報取得<br>- AWS SDK で直接 Cognito API 呼び出し<br>```typescript<br>const users = await cognito.send(<br>  new AdminListUsersInGroupCommand({<br>    UserPoolId,<br>    GroupName: 'User-RAG'<br>  })<br>)<br>``` |

### 3-2. 新規ユーザーを追加

| No | 処理内容 | 使用するAWSサービス | データ保存場所 | SI開発要否 | 開発内容 |
|----|---------|------------------|-------------|----------|---------|
| 3.2.1 | メールアドレス入力<br>`sato@isuzu.co.jp` | - | - | ✅ **開発必要** | **React UI**<br>- メールアドレス入力フォーム<br>- バリデーション |
| 3.2.2 | "追加"ボタンクリック<br>API リクエスト送信<br>POST `/api/admin/assign-pending-group` | **API Gateway** | - | ✅ **開発必要** | **React実装**<br>```typescript<br>await fetch(`${API_ENDPOINT}/admin/assign-pending-group`, {<br>  method: 'POST',<br>  headers: {<br>    'Authorization': `Bearer ${idToken}`<br>  },<br>  body: JSON.stringify({<br>    email: 'sato@isuzu.co.jp',<br>    groups: ['User-RAG']<br>  })<br>})<br>``` |
| 3.2.3 | Lambda 実行<br>**処理は1-2と同じ**<br>（既存の AssignPendingGroup を再利用） | **Lambda**<br>**S3** or **Cognito** | **S3バケット** or **Cognito** | ✅ **開発必要**<br>（既存Lambda再利用） | **既存のLambda実装を再利用**<br>- 佐藤さんが既にログイン済み<br>  → 直接 `User-RAG` グループに追加<br>- 佐藤さんが未ログイン<br>  → S3 に `sato@isuzu.co.jp.json` 保存 |

**処理フロー**:
1. 佐藤さんが既にログイン済み → 直接 `User-RAG` グループに追加（ステップ1-4参照）
2. 佐藤さんが未ログイン → S3 に `sato@isuzu.co.jp.json` 保存（ステップ1-5参照）
3. 佐藤さんが初回ログイン → Post Authentication Triggerで自動追加（ステップ2-4～2-5参照）

---

## 💻 画面イメージ

### 1. システム管理者の登録画面

```
┌─────────────────────────────────────────┐
│ 全社共通LLMゲートウェイ - 管理画面      │
├─────────────────────────────────────────┤
│                                         │
│  部門管理者の登録                       │
│                                         │
│  メールアドレス:                        │
│  ┌─────────────────────────────────┐   │
│  │ tanaka@isuzu.co.jp              │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ユースケース（複数選択可）:            │
│  ☑ RAG                                  │
│  ☐ Translation                          │
│  ☐ CodeGen                              │
│                                         │
│  ☑ 通知メールを送信する（オプション）   │
│                                         │
│         ┌───────────────┐              │
│         │ 登録する      │              │
│         └───────────────┘              │
│                                         │
└─────────────────────────────────────────┘
```

### 2. 登録完了メッセージ

```
┌─────────────────────────────────────────┐
│  ✅ 登録完了                             │
│                                         │
│  tanaka@isuzu.co.jp を                  │
│  Admin-RAG に登録しました。             │
│                                         │
│  対象者が初回ログイン時に、             │
│  自動的に管理者権限が付与されます。     │
│                                         │
│  ［オプション］                         │
│  以下のURLを田中さんに共有してください: │
│  https://llm-gateway.isuzu.co.jp        │
│                                         │
│         ┌───────────────┐              │
│         │ 閉じる        │              │
│         └───────────────┘              │
└─────────────────────────────────────────┘
```

### 3. 田中さんのログイン画面

```
┌─────────────────────────────────────────┐
│                                         │
│        全社共通LLMゲートウェイ          │
│                                         │
│         Generative AI Platform          │
│                                         │
│                                         │
│      ┌─────────────────────────────┐   │
│      │                             │   │
│      │  Entra ID でログイン       │   │
│      │                             │   │
│      └─────────────────────────────┘   │
│                                         │
│                                         │
│   ※社内アカウントでログインします      │
│                                         │
└─────────────────────────────────────────┘
```

### 4. 初回ログイン後の管理画面

```
┌─────────────────────────────────────────┐
│ 全社共通LLMゲートウェイ                 │  田中太郎 ▼
├─────────────────────────────────────────┤
│ ☰ メニュー                             │
│   ■ ホーム                             │
│   ■ RAGチャット                        │
│   ■ ユーザー管理 ← 管理者のみ表示      │
│   ■ ドキュメント管理 ← 管理者のみ表示  │
│   ■ 設定                               │
├─────────────────────────────────────────┤
│                                         │
│  ようこそ、田中さん                     │
│                                         │
│  あなたは RAG 管理者です                │
│                                         │
│  ■ 現在のユーザー数: 5名                │
│  ■ 登録済みドキュメント: 120件          │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ ユーザーを追加                 │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

---

## 🔐 重要ポイント

### ❌ Cognito 招待メールは送られません

| 項目 | 内容 |
|------|------|
| **理由** | ・Cognito にユーザーを事前作成していない<br>・SAML 連携でパスワード不要<br>・S3 に JSON ファイルを保存するだけ |
| **田中さんに必要な情報** | ・ログインURL: `https://llm-gateway.isuzu.co.jp`<br>・既存の Entra ID アカウント（既に知っている） |
| **新しいパスワードは必要？** | ❌ **不要**（Entra ID のパスワードを使用） |
| **Cognito のパスワードは？** | ❌ **不要**（SAML 連携なので Cognito パスワードは存在しない） |

### ✅ 初回ログイン時に自動で権限付与

| タイミング | 処理内容 |
|-----------|---------|
| **ログイン前** | S3 に `tanaka@isuzu.co.jp.json` が保存されている<br>Cognito に田中さんは存在しない |
| **ログイン時** | Entra ID で認証成功<br>Cognito User Pool にユーザー自動作成<br>Post Authentication Trigger 実行 |
| **ログイン直後** | Lambda が S3 から JSON 読み取り<br>`Admin-RAG` グループに自動追加<br>S3 から JSON 削除 |
| **ログイン完了** | JWT に `cognito:groups: ["Admin-RAG"]` が含まれる<br>管理画面が表示される |

---

## 📊 開発要素まとめ

### 新規開発が必要な要素

| カテゴリ | 開発要素 | 使用技術 | 工数見積 |
|---------|---------|---------|---------|
| **管理画面UI** | システム管理者画面<br>- 部門管理者登録<br>- メール入力フォーム<br>- ユースケース選択 | React, TypeScript, Material-UI | 10人日 |
| **管理画面UI** | 部門管理者画面<br>- ユーザー一覧表示<br>- 新規ユーザー追加<br>- Identity Pool 連携 | React, TypeScript, AWS SDK | 12人日 |
| **Lambda** | AssignPendingGroup<br>- Cognito 存在確認<br>- S3 保存/直接追加分岐 | TypeScript, AWS SDK | 5人日 |
| **Lambda** | PostAuthentication<br>- S3 読み取り<br>- グループ自動追加<br>- S3 削除 | TypeScript, AWS SDK | 5人日 |
| **インフラ（CDK）** | S3 バケット<br>- pending-assignments<br>- ライフサイクルポリシー | CDK (TypeScript) | 2人日 |
| **インフラ（CDK）** | API Gateway<br>- エンドポイント定義<br>- Cognito Authorizer | CDK (TypeScript) | 3人日 |
| **インフラ（CDK）** | Cognito 設定<br>- User Pool<br>- Groups 定義<br>- IAM Role マッピング<br>- SAML 連携 | CDK (TypeScript) | 8人日 |

**合計**: **約45人日**（管理者登録機能のみ、自動メール送信なし）

### AWSネイティブ機能（開発不要）

| 機能 | 使用サービス |
|------|------------|
| SAML 2.0 認証 | Cognito User Pool + Entra ID |
| JWT 発行・検証 | Cognito User Pool |
| OAuth 2.0 Authorization Code Flow | Cognito User Pool |
| グループメンバーシップ管理 | Cognito User Pool |
| IAM Role 一時認証情報発行 | Cognito Identity Pool |

---

## 📈 データ保存状態の変遷

### 初期状態（登録前）

```
[S3: pending-assignments]
└─ (空)

[Cognito User Pool]
├─ Users: (空)
└─ Groups:
    ├─ SystemAdmin (Members: [system-admin@...])
    └─ Admin-RAG (Members: [])
```

### ステップ1完了後（登録完了、未ログイン）

```
[S3: pending-assignments]
└─ tanaka@isuzu.co.jp.json
    {
      "email": "tanaka@isuzu.co.jp",
      "groups": ["Admin-RAG"],
      "requestedBy": "system-admin@...",
      "requestedAt": "2025-12-11T10:00:00Z"
    }

[Cognito User Pool]
├─ Users: (空)  ← tanaka はまだ未作成
└─ Groups:
    └─ Admin-RAG (Members: [])
```

### ステップ2完了後（初回ログイン完了）

```
[S3: pending-assignments]
└─ (空)  ← tanaka@isuzu.co.jp.json は削除済み

[Cognito User Pool]
├─ Users:
│   └─ tanaka@isuzu.co.jp
│       ├─ email: tanaka@isuzu.co.jp
│       ├─ email_verified: true
│       ├─ identities: [{ providerName: "EntraID" }]
│       └─ Groups: ["Admin-RAG"]  ← 自動追加完了
└─ Groups:
    └─ Admin-RAG
        ├─ RoleArn: arn:aws:iam::xxx:role/AdminRole
        └─ Members: ["tanaka@isuzu.co.jp"]  ← 追加

[ブラウザ LocalStorage]
├─ idToken: "eyJhbGci..." (cognito:groups: ["Admin-RAG"] 含む)
├─ accessToken: "eyJhbGci..."
└─ refreshToken: "..."
```

### ステップ3完了後（一般ユーザー登録、未ログイン）

```
[S3: pending-assignments]
└─ sato@isuzu.co.jp.json  ← 新規追加
    {
      "email": "sato@isuzu.co.jp",
      "groups": ["User-RAG"],
      "requestedBy": "tanaka@isuzu.co.jp",
      "requestedAt": "2025-12-11T11:00:00Z"
    }

[Cognito User Pool]
├─ Users:
│   └─ tanaka@isuzu.co.jp (Groups: ["Admin-RAG"])
└─ Groups:
    ├─ Admin-RAG (Members: [tanaka@...])
    └─ User-RAG (Members: [])  ← sato はまだ未追加
```

---

## 🚀 次のステップ

このドキュメントで管理者登録フローの理解が深まったら、次は：

1. ✅ 一般ユーザーがRAGチャットを開始するフロー
2. ✅ ドキュメントアップロード＆インジェスト処理
3. ✅ 部門別フィルタリング実装詳細
4. ✅ モニタリング・ダッシュボード構築

---

**作成者**: SI開発チーム
**最終更新**: 2025-12-11
**バージョン**: 4.0（詳細版・表形式）
