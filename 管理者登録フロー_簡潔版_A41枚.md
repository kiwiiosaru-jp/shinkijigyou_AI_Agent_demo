# マルチテナント認証・認可システム - 管理者登録フロー（簡潔版）

**対象システム**: 全社共通LLMゲートウェイ | **想定規模**: 8,000名 × 100ユースケース | **作成日**: 2025-12-11

---

## 📋 推奨フロー

### システム管理者の操作
```
1. 管理画面で tanaka@isuzu.co.jp を Admin-RAG に登録
2. システムが S3 に JSON ファイル保存（s3://pending-assignments/tanaka@isuzu.co.jp.json）
3. 画面に「登録完了。ログインURLを共有してください」と表示
4. 業務メールで田中さんに通知（手動 or SES自動送信）
```

### 田中さん（部門管理者）の初回ログイン
```
1. メール受信 → URLクリック（https://llm-gateway.isuzu.co.jp）
2. 「Entra ID でログイン」ボタンをクリック
3. Entra ID で認証（既存アカウント・既存パスワード使用）
4. 【自動処理】Post Authentication Trigger 実行
   - S3 から JSON 読み取り → Admin-RAG グループに追加 → S3 削除
5. 管理画面が表示（管理者権限付与完了）
```

---

## 🔄 処理フロー詳細

### ステップ1: システム管理者が登録（未ログインユーザーの場合）

| No | 処理内容 | AWSサービス | データ保存場所 | SI開発 |
|----|---------|-----------|-------------|--------|
| 1.1 | 管理画面でメール入力・登録ボタンクリック | - | - | ✅ |
| 1.2 | POST `/api/admin/assign-pending-group`<br>JWT検証（SystemAdmin権限確認） | API Gateway<br>Cognito Authorizer | - | ✅ |
| 1.3 | Lambda: AssignPendingGroup 実行<br>`AdminGetUser` → UserNotFoundException | Lambda<br>Cognito User Pool | - | ✅ |
| 1.4 | S3 に JSON ファイル保存<br>Key: `{email}.json` | S3 | `s3://pending-assignments/`<br>`tanaka@isuzu.co.jp.json`<br>```json<br>{<br>  "email": "tanaka@...",<br>  "groups": ["Admin-RAG"],<br>  "requestedBy": "admin@...",<br>  "requestedAt": "2025-12-11T10:00:00Z"<br>}<br>``` | ✅ |
| 1.5 | レスポンス返却<br>`{ status: "pending" }` | - | - | ✅ |

### ステップ2: 田中さんが初回ログイン

| No | 処理内容 | AWSサービス | データ保存場所 | SI開発 |
|----|---------|-----------|-------------|--------|
| 2.1 | ブラウザでURL入力 → Cognito Hosted UI 表示 | CloudFront, ALB, ECS<br>Cognito Hosted UI | - | ✅ / ❌ |
| 2.2 | Entra ID で SAML 認証 | Entra ID (SAML) | Entra ID 内部DB | ❌ |
| 2.3 | Cognito User Pool にユーザー自動作成 | Cognito User Pool | User Pool 内部DB<br>- Username: tanaka@...<br>- email_verified: true<br>- identities: [EntraID] | ❌ |
| 2.4 | Post Authentication Trigger 実行<br>Lambda: PostAuthentication | Lambda (Cognito Trigger) | - | ✅ |
| 2.5 | S3 から JSON 取得 → AdminAddUserToGroup 実行<br>→ S3 削除 | S3<br>Cognito User Pool | User Pool 内部DB<br>Groups → Admin-RAG<br>Members: [tanaka@...] | ✅ |
| 2.6 | JWT 発行（cognito:groups: ["Admin-RAG"] 含む） | Cognito User Pool | - | ❌ |
| 2.7 | フロントエンドで Token 取得・LocalStorage 保存 | - | Browser LocalStorage | ✅ |

### ステップ3: 部門管理者が一般ユーザーを登録

| No | 処理内容 | AWSサービス | SI開発 |
|----|---------|-----------|--------|
| 3.1 | 「ユーザー管理」メニュー → ユーザー一覧表示<br>`AdminListUsersInGroup` | Cognito Identity Pool<br>Cognito User Pool | ✅ |
| 3.2 | メール入力 → "追加"ボタンクリック<br>API呼び出し（既存 AssignPendingGroup Lambda 再利用） | API Gateway<br>Lambda | ✅ |

**処理**: 佐藤さんが既にログイン済み → 直接グループ追加 / 未ログイン → S3 保存（ステップ1と同様）

---

## 🔐 重要ポイント

| 項目 | 内容 |
|------|------|
| **Cognito招待メール** | ❌ **送られません**<br>理由: Cognitoにユーザーを事前作成していない、SAML連携でパスワード不要 |
| **新しいパスワード** | ❌ **不要**（Entra IDのパスワードを使用） |
| **権限付与タイミング** | 初回ログイン時に自動（Post Authentication Trigger） |
| **通知方法** | 業務メール（手動 or SES自動送信・オプション+3人日） |

---

## 📊 開発要素まとめ

### 新規開発が必要な要素

| カテゴリ | 開発要素 | 使用技術 | 工数見積 |
|---------|---------|---------|---------|
| **管理画面UI** | システム管理者画面<br>- 部門管理者登録<br>- メール入力フォーム<br>- ユースケース選択 | React, TypeScript, Material-UI | 10人日 |
| **管理画面UI** | 部門管理者画面<br>- ユーザー一覧表示<br>- 新規ユーザー追加<br>- Identity Pool 連携 | React, TypeScript, AWS SDK | 12人日 |
| **Lambda** | AssignPendingGroup<br>- Cognito 存在確認<br>- S3 保存/直接追加分岐 | TypeScript, AWS SDK | 5人日 |
| **Lambda** | PostAuthentication<br>- S3 読み取り<br>- グループ自動追加<br>- S3 削除 | TypeScript, AWS SDK | 5人日 |
| **インフラ（CDK）** | S3 バケット<br>- pending-assignments<br>- ライフサイクルポリシー | CDK (TypeScript) | 2人日 |
| **インフラ（CDK）** | API Gateway<br>- エンドポイント定義<br>- Cognito Authorizer | CDK (TypeScript) | 3人日 |
| **インフラ（CDK）** | Cognito 設定<br>- User Pool<br>- Groups 定義<br>- IAM Role マッピング<br>- SAML 連携 | CDK (TypeScript) | 8人日 |

**合計**: **約45人日**（管理者登録機能のみ、自動メール送信なし）

### AWSネイティブ機能（開発不要）

| 機能 | 使用サービス |
|------|------------|
| SAML 2.0 認証 | Cognito User Pool + Entra ID |
| JWT 発行・検証 | Cognito User Pool |
| OAuth 2.0 Authorization Code Flow | Cognito User Pool |
| グループメンバーシップ管理 | Cognito User Pool |
| IAM Role 一時認証情報発行 | Cognito Identity Pool |

---

## 🏗️ アーキテクチャ方針

- ✅ **DynamoDB 不使用**（S3 JSON ファイル方式）
- ✅ **Cognito 事前登録不要**（初回ログイン時に自動作成）
- ✅ **Cognito 招待メール不要**（業務メールで通知）
- ✅ **S3 ライフサイクルポリシー**（30日で自動削除）

---

## 📈 データフロー図

```
[システム管理者] → [React管理画面] → [API Gateway] → [Lambda: AssignPendingGroup]
                                           ↓
                                      [Cognito User Pool]
                                      AdminGetUser → UserNotFoundException
                                           ↓
                                      [S3 保存]
                                      s3://pending-assignments/tanaka@isuzu.co.jp.json

[田中さん] → [ログイン画面] → [Cognito Hosted UI] → [Entra ID (SAML認証)]
                                           ↓
                                      [Cognito User Pool]
                                      ユーザー自動作成
                                           ↓
                                      [Lambda: PostAuthentication (Trigger)]
                                      S3読取 → AdminAddUserToGroup → S3削除
                                           ↓
                                      [JWT発行]
                                      cognito:groups: ["Admin-RAG"]
                                           ↓
                                      [React管理画面] 権限付与完了
```

---

**作成者**: SI開発チーム | **最終更新**: 2025-12-11 | **バージョン**: 5.0（簡潔版・A4 1枚）
