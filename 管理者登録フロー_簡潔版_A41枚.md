# マルチテナント認証・認可システム - 管理者登録フロー（簡潔版）

**対象システム**: 全社共通LLMゲートウェイ | **想定規模**: 8,000名 × 100部門（テナント） | **作成日**: 2025-12-11

## アーキテクチャの前提

- **テナント = 部門 = Entra ID セキュリティグループ**: 営業部（SG-Sales）、マーケ部（SG-Marketing）等
- **Cognitoグループ**: 各部門に対して `Admin-{SecurityGroup}` と `User-{SecurityGroup}` を動的作成
- **権限管理**: Cognito側で管理者/一般ユーザーを区別（Entra IDからは所属部門のみ受信）
- **JWT自動セット**: Cognitoが `cognito:groups` に所属グループを自動的に含める（開発不要）

---

## 📋 推奨フロー

### ステップ0: 部門（テナント）の作成
```
1. システム管理者が管理画面で「新規部門作成」をクリック
2. 部門名（Entra IDのセキュリティグループ名）を入力: SG-Sales
3. 「作成」ボタンをクリック
   ↓ システムが自動処理
4. Cognitoグループ作成: Admin-SG-Sales（管理者用）
5. Cognitoグループ作成: User-SG-Sales（一般ユーザー用）
6. IAM Role 紐付け（それぞれのグループに適切な権限を設定）
```

### ステップ1: システム管理者の操作
```
1. 管理画面で tanaka@isuzu.co.jp を SG-Sales（営業部）の管理者として登録
2. システムが S3 に JSON ファイル保存（s3://pending-assignments/tanaka@isuzu.co.jp.json）
   - groups: ["Admin-SG-Sales"]
3. 画面に「登録完了。ログインURLを共有してください」と表示
4. 業務メールで田中さんに通知（手動 or SES自動送信）
```

### ステップ2: 田中さん（部門管理者）の初回ログイン
```
1. メール受信 → URLクリック（https://llm-gateway.isuzu.co.jp）
2. 「Entra ID でログイン」ボタンをクリック
3. Entra ID で認証（既存アカウント・既存パスワード使用）
   ※ Entra IDから所属セキュリティグループ（SG-Sales）が渡される
4. 【自動処理】Cognito User Pool にユーザー自動作成
5. 【自動処理】Post Authentication Trigger 実行
   - S3 から JSON 読み取り → Admin-SG-Sales グループに追加 → S3 削除
6. 【自動処理】JWT発行（cognito:groups: ["Admin-SG-Sales"] を自動セット）
7. 管理画面が表示（管理者権限付与完了）
   ※ フロントエンドがJWTから管理者権限を判定
```

---

## 🔄 処理フロー詳細

### ステップ1: システム管理者が登録（未ログインユーザーの場合）

| No | 処理内容 | AWSサービス | データ保存場所 | SI開発 |
|----|---------|-----------|-------------|--------|
| 1.1 | 管理画面でメール入力・登録ボタンクリック | - | - | ✅ |
| 1.2 | Lambda: AssignPendingGroup 実行<br>前提: 部門作成時に以下の2つのCognitoグループが作成済み<br>- Admin-{SecurityGroup}（管理者用）<br>- User-{SecurityGroup}（一般ユーザー用）<br>処理: ユーザー存在確認と処理分岐 | Lambda<br>Cognito User Pool<br>S3 | - | ✅ |
| 1.3 | Lambda: AssignPendingGroup 実行<br>`AdminGetUser` → UserNotFoundException | Lambda<br>Cognito User Pool | - | ✅ |
| 1.4 | S3 に JSON ファイル保存<br>Key: `{email}.json` | S3 | `s3://pending-assignments/`<br>`tanaka@isuzu.co.jp.json`<br>```json<br>{<br>  "email": "tanaka@...",<br>  "groups": ["Admin-RAG"],<br>  "requestedBy": "admin@...",<br>  "requestedAt": "2025-12-11T10:00:00Z"<br>}<br>``` | ✅ |
| 1.5 | レスポンス返却<br>`{ status: "pending" }` | - | - | ✅ |

### ステップ2: 田中さんが初回ログイン

| No | 処理内容 | AWSサービス | データ保存場所 | SI開発 |
|----|---------|-----------|-------------|--------|
| 2.1 | ブラウザでURL入力 → Cognito Hosted UI 表示 | CloudFront, ALB, ECS<br>Cognito Hosted UI | - | ✅ / ❌ |
| 2.2 | Entra ID で SAML 認証 | Entra ID (SAML) | Entra ID 内部DB | ❌ |
| 2.3 | Cognito User Pool にユーザー自動作成 | Cognito User Pool | User Pool 内部DB<br>- Username: tanaka@...<br>- email_verified: true<br>- identities: [EntraID] | ❌ |
| 2.4 | Post Authentication Trigger 実行<br>Lambda: PostAuthentication | Lambda (Cognito Trigger) | - | ✅ |
| 2.5 | S3 から JSON 取得 → AdminAddUserToGroup 実行<br>→ S3 削除 | S3<br>Cognito User Pool | User Pool 内部DB<br>Groups → Admin-RAG<br>Members: [tanaka@...] | ✅ |
| 2.6 | JWT 発行（cognito:groups: ["Admin-RAG"] 含む） | Cognito User Pool | - | ❌ |
| 2.7 | フロントエンドで Token 取得・LocalStorage 保存 | - | Browser LocalStorage | ✅ |

### ステップ3: 部門管理者が一般ユーザーを登録

| No | 処理内容 | AWSサービス | SI開発 |
|----|---------|-----------|--------|
| 3.1 | 「ユーザー管理」メニュー → ユーザー一覧表示<br>`AdminListUsersInGroup` | Cognito Identity Pool<br>Cognito User Pool | ✅ |
| 3.2 | メール入力 → "追加"ボタンクリック<br>API呼び出し（既存 AssignPendingGroup Lambda 再利用） | API Gateway<br>Lambda | ✅ |
| 3.3 | 一般ユーザーへのメール通知<br>- ユーザー追加成功後に自動メール送信<br>- メールテンプレート作成（ログインURL含む）<br>※ 一般ユーザーはURL（https://llm-gateway.isuzu.co.jp）をクリックしてEntra ID認証を行い、初回ログイン時に自動的にUser-{SecurityGroup}に追加される | Lambda<br>Amazon SES | ✅ |

**処理**: 佐藤さんが既にログイン済み → 直接グループ追加 / 未ログイン → S3 保存（ステップ1と同様）

---

## 🔐 重要ポイント

| 項目 | 内容 |
|------|------|
| **Cognito招待メール** | ❌ **送られません**<br>理由: Cognitoにユーザーを事前作成していない、SAML連携でパスワード不要 |
| **SAML連携の制約** | `AdminCreateUser`でNative Userを作成すると、SAMLログイン時に別のFederated Userが自動作成され重複する。S3保留 + カスタムメール通知を採用。 |
| **新しいパスワード** | ❌ **不要**（Entra IDのパスワードを使用） |
| **権限付与タイミング** | 初回ログイン時に自動（Post Authentication Trigger） |
| **通知方法** | 業務メール（手動 or SES自動送信・オプション+3人日） |

---

## 📊 開発要素まとめ

### 新規開発が必要な要素

| カテゴリ | 開発要素 | 使用技術 | 工数見積 |
|---------|---------|---------|---------|
| **管理画面UI（システム管理者）** | - 部門作成UI<br>- 部門管理者登録<br>- メール入力フォーム<br>- 部門選択 | React, TypeScript, Material-UI | **12人日** |
| **管理画面UI（部門管理者）** | - ユーザー一覧表示<br>- 新規ユーザー追加<br>- Identity Pool 連携 | React, TypeScript, AWS SDK | **12人日** |
| **Lambda（CreateTenant）** | - Cognitoグループ動的作成<br>- IAM Role 紐付け | TypeScript, AWS SDK | **5人日** |
| **Lambda（AssignPendingGroup）** | - Cognito 存在確認<br>- S3 保存/直接追加分岐 | TypeScript, AWS SDK | **5人日** |
| **Lambda（PostAuthentication）** | - S3 読み取り<br>- グループ自動追加<br>- S3 削除 | TypeScript, AWS SDK | **5人日** |
| **Lambda（SendNotification）** | - メール送信<br>- メールテンプレート<br>- SES設定 | TypeScript, AWS SDK, SES | **3人日** |
| **インフラ（CDK）- S3** | - pending-assignments バケット<br>- ライフサイクルポリシー | CDK (TypeScript) | **2人日** |
| **インフラ（CDK）- API Gateway** | - エンドポイント定義<br>- Cognito Authorizer | CDK (TypeScript) | **3人日** |
| **インフラ（CDK）- Cognito** | - User Pool<br>- SystemAdmin グループ<br>- IAM Role マッピング<br>- SAML 連携<br>※部門別グループは動的作成 | CDK (TypeScript) | **8人日** |

**合計**: **約55人日**（管理者・一般ユーザー登録機能、メール通知含む）

### AWSネイティブ機能（開発不要）

| 機能 | 使用サービス |
|------|------------|
| SAML 2.0 認証 | Cognito User Pool + Entra ID |
| JWT 発行・検証 | Cognito User Pool |
| OAuth 2.0 Authorization Code Flow | Cognito User Pool |
| グループメンバーシップ管理 | Cognito User Pool |
| IAM Role 一時認証情報発行 | Cognito Identity Pool |

---

## 🏗️ アーキテクチャ方針

- ✅ **DynamoDB 不使用**（S3 JSON ファイル方式）
- ✅ **Cognito 事前登録不要**（初回ログイン時に自動作成）
- ✅ **Cognito 招待メール不要**（業務メールで通知）
- ✅ **S3 ライフサイクルポリシー**（30日で自動削除）

---

## 📈 データフロー図

```
【ステップ0: 部門作成】
[システム管理者] → [React管理画面] → [Lambda: CreateTenant]
                                      ↓
                                [Cognito] グループ作成
                                - Admin-SG-Sales
                                - User-SG-Sales
                                      ↓
                                [IAM Role 紐付け]

【ステップ1: 部門管理者登録】
[システム管理者] → [React管理画面] → [API Gateway] → [Lambda: AssignPendingGroup]
                                           ↓
                                      [Cognito] AdminGetUser → UserNotFoundException
                                           ↓
                                      [S3] tanaka@isuzu.co.jp.json 保存
                                      {
                                        "email": "tanaka@isuzu.co.jp",
                                        "groups": ["Admin-SG-Sales"]
                                      }

【ステップ2: 初回ログイン】
[田中さん] → [Cognito Hosted UI] → [Entra ID SAML認証]
                                      ↓ セキュリティグループ（SG-Sales）を渡す
                                   [Cognito] ユーザー作成
                                      ↓
                                   [Lambda: PostAuthentication (Trigger)]
                                   S3読取 → AdminAddUserToGroup(Admin-SG-Sales) → S3削除
                                      ↓
                                   [JWT発行] ← Cognitoが自動セット
                                   {
                                     "cognito:groups": ["Admin-SG-Sales"],
                                     "email": "tanaka@isuzu.co.jp"
                                   }
                                      ↓
                                   [React管理画面]
                                   JWT解析 → Admin-* 判定 → 管理者メニュー表示
```

---

**作成者**: SI開発チーム | **最終更新**: 2025-12-11 | **バージョン**: 5.0（簡潔版・A4 1枚）
