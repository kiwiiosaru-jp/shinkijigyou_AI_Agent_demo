# マルチテナント認証・認可システム - 管理者登録フロー（統合版）

**対象システム**: 全社共通LLMゲートウェイ | **想定規模**: 8,000名 × 100部門（テナント） | **作成日**: 2025-12-11

## アーキテクチャの前提

- **テナント = 部門 = Entra ID セキュリティグループ**: 営業部（SG-Sales）、マーケ部（SG-Marketing）等
- **Cognitoグループ**: 各部門に対して `Admin-{SecurityGroup}` と `User-{SecurityGroup}` を動的作成
- **権限管理**: Cognito側で管理者/一般ユーザーを区別（Entra IDからは所属部門のみ受信）
- **JWT自動セット**: Cognitoが `cognito:groups` に所属グループを自動的に含める（開発不要）

---

## 📋 推奨フロー

### ステップ0: 部門（テナント）の作成
```
1. システム管理者が管理画面で「新規部門作成」をクリック
2. 部門名（Entra IDのセキュリティグループ名）を入力: SG-Sales
3. 「作成」ボタンをクリック
   ↓ システムが自動処理
4. Cognitoグループ作成: Admin-SG-Sales（管理者用）
5. Cognitoグループ作成: User-SG-Sales（一般ユーザー用）
6. IAM Role 紐付け（それぞれのグループに適切な権限を設定）
```

### ステップ1: 部門管理者の登録
```
1. 管理画面で tanaka@isuzu.co.jp を SG-Sales（営業部）の管理者として登録
2. システムが S3 に JSON ファイル保存（s3://pending-assignments/tanaka@isuzu.co.jp.json）
   - groups: ["Admin-SG-Sales"]
3. 画面に「登録完了。ログインURLを共有してください」と表示
4. 業務メールで田中さんに通知（手動 or SES自動送信）
```

### ステップ2: 田中さん（部門管理者）の初回ログイン
```
1. メール受信 → URLクリック（https://llm-gateway.isuzu.co.jp）
2. 「Entra ID でログイン」ボタンをクリック
3. Entra ID で認証（既存アカウント・既存パスワード使用）
   ※ Entra IDから所属セキュリティグループ（SG-Sales）が渡される
4. 【自動処理】Cognito User Pool にユーザー自動作成
5. 【自動処理】Post Authentication Trigger 実行
   - S3 から JSON 読み取り → Admin-SG-Sales グループに追加 → S3 削除
6. 【自動処理】JWT発行（cognito:groups: ["Admin-SG-Sales"] を自動セット）
7. 管理画面が表示（管理者権限付与完了）
   ※ フロントエンドがJWTから管理者権限を判定
```

---

## 🔄 処理フロー詳細

### ステップ1: システム管理者が部門管理者を登録（未ログインユーザーの場合）

**前提**: 部門（SG-Sales）は既に作成済み（ステップ0で作成）

| No | 処理内容 | AWSサービス | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|----|---------|-----------|----------|---------|---------|---------|------|
| 1.1 | 管理者情報の入力と登録 | - | ✅ **開発必要** | **管理画面UI実装**<br>- メールアドレス入力フォーム作成<br>- 管理対象部門の選択UI（ドロップダウン: SG-Sales, SG-Marketing等）<br>- メール形式バリデーション<br>- 登録ボタンクリックイベント処理 | 管理画面UI<br>（システム管理者） | React<br>TypeScript<br>Material-UI | 3人日 |
| 1.2 | グループ割当処理 | API Gateway<br>Lambda<br>Cognito User Pool<br>S3 | ✅ **開発必要** | **バックエンド実装（Lambda + インフラ）**<br>- 前提: 部門作成時に以下の2つのCognitoグループが作成済み<br>  - Admin-{SecurityGroup}（管理者用）<br>  - User-{SecurityGroup}（一般ユーザー用）<br>- Lambda: ユーザー存在確認と処理分岐<br>- 既存ユーザー: 直接Admin-{SecurityGroup}に追加<br>- 未ログインユーザー: S3に保留情報を保存<br>- S3バケット作成と30日自動削除ポリシー設定 | API Gateway<br>+<br>Lambda<br>AssignPendingGroup<br>+<br>インフラ（CDK）<br>S3 | CDK<br>TypeScript<br>AWS SDK | 10人日 |
| 1.3 | 登録完了通知 | - | ✅ **開発必要** | **Lambda + フロントエンド実装**<br>- Lambda: JSON形式でステータス返却<br>- 画面: レスポンス受信後にトースト通知表示<br>- 「初回ログイン時に自動適用」メッセージ | Lambda + 管理画面UI | TypeScript<br>React | 含む |

**ステップ1 小計**: 管理画面UI 3人日 + バックエンド処理 10人日 = **13人日**

---

### ステップ2: 田中さんが初回ログイン

| No | 処理内容 | AWSサービス | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|----|---------|-----------|----------|---------|---------|---------|------|
| 2.1 | ログイン画面表示 | CloudFront<br>ALB, ECS<br>Cognito Hosted UI | ✅ / ❌ | **フロントエンド実装 + 設定**<br>- ログインページ作成とCognito Hosted UIへのリダイレクト処理<br>- Hosted UIのカスタマイズ（ロゴ・背景色） | 管理画面UI | React<br>TypeScript | 2人日 |
| 2.2 | SAML認証 | Entra ID (SAML) | ❌ **顧客側設定** | **設定作業のみ**<br>- Entra ID と Cognito 間のSAML連携設定<br>- メタデータXML交換<br>- 属性マッピング設定（email, name, セキュリティグループ等）<br>※ Entra IDから所属セキュリティグループ（SG-Sales等）が渡される | - | - | - |
| 2.3 | ユーザー自動作成 | Cognito User Pool | ❌ **AWS標準** | AWS標準機能（開発不要）<br>※ SAML認証成功時にCognitoが自動的にユーザー作成 | - | - | - |
| 2.4 | 保留情報の取得 | Lambda<br>(Cognito Trigger) | ✅ **開発必要** | **Lambda関数実装 + インフラ構築**<br>- S3から保留ファイル取得（メールアドレスをキーに検索）<br>- JSONデータのパース（例: ["Admin-SG-Sales"]）<br>- NoSuchKey例外のハンドリング<br>- Cognito Triggerの設定 | Lambda<br>PostAuthentication | TypeScript<br>AWS SDK | 3人日 |
| 2.5 | グループ自動追加 | Cognito User Pool<br>S3 | ✅ **開発必要** | **Lambda関数実装**<br>- 取得したグループリスト（例: Admin-SG-Sales）をループ処理<br>- 各グループにユーザーを追加<br>- 処理完了後にS3ファイルを削除<br>- エラーログ出力 | Lambda<br>PostAuthentication | TypeScript<br>AWS SDK | 2人日 |
| 2.6 | JWT発行 | Cognito User Pool | ❌ **AWS標準** | **AWS標準機能（開発不要）**<br>※ Cognitoが自動的に `cognito:groups` にグループ情報をセット<br>例: `{"cognito:groups": ["Admin-SG-Sales"]}` | - | - | - |
| 2.7 | トークン取得と画面表示 | - | ✅ **開発必要** | **フロントエンド実装**<br>- コールバックURLでAuthorization Code受信<br>- Token エンドポイントへPOSTリクエスト<br>- 取得したToken をLocalStorageに保存<br>- JWTから管理者権限を判定（cognito:groupsを参照）<br>- ホーム画面へリダイレクト処理 | 管理画面UI | React<br>TypeScript | 3人日 |

**ステップ2 小計**: 管理画面UI 5人日 + Lambda (PostAuthentication) 5人日 = **10人日**

---

### ステップ3: 部門管理者が一般ユーザーを登録

| No | 処理内容 | AWSサービス | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|----|---------|-----------|----------|---------|---------|---------|------|
| 3.1 | ユーザー管理画面 | Cognito Identity Pool<br>Cognito User Pool | ✅ **開発必要** | **フロントエンド実装**<br>- 「ユーザー管理」メニューの表示制御（管理者のみ）<br>- Identity Pool から一時認証情報を取得<br>- AdminListUsersInGroup API でユーザー一覧取得<br>- ユーザー一覧のテーブル表示UI<br>- ページネーション実装 | 管理画面UI<br>（部門管理者） | React<br>TypeScript<br>AWS SDK | 7人日 |
| 3.2 | ユーザー追加 | API Gateway<br>Lambda | ✅ **開発必要** | **フロントエンド実装**<br>- メールアドレス入力フォーム<br>- バリデーション処理<br>- API呼び出し（既存AssignPendingGroup再利用）<br>- 追加完了後のユーザー一覧再読み込み | 管理画面UI<br>（部門管理者） | React<br>TypeScript | 5人日 |

**ステップ3 小計**: 管理画面UI（部門管理者） **12人日**

---

### ステップ0: 部門（テナント）作成機能

| No | 処理内容 | AWSサービス | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|----|---------|-----------|----------|---------|---------|---------|------|
| 0.1 | 部門作成UI | - | ✅ **開発必要** | **管理画面UI実装**<br>- 部門名入力フォーム（例: SG-Sales）<br>- 作成ボタンクリック処理<br>- バリデーション（重複チェック） | 管理画面UI<br>（システム管理者） | React<br>TypeScript | 2人日 |
| 0.2 | Cognitoグループ動的作成 | Lambda<br>Cognito User Pool | ✅ **開発必要** | **Lambda関数実装**<br>- Cognitoグループ作成（Admin-{SecurityGroup}）<br>- Cognitoグループ作成（User-{SecurityGroup}）<br>- IAM Role紐付け<br>- エラーハンドリング（既存グループ重複） | Lambda<br>CreateTenant | TypeScript<br>AWS SDK | 5人日 |

**ステップ0 小計**: **7人日**

### インフラ（Cognito初期設定）

| 項目 | 内容 | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|------|------|----------|---------|---------|---------|------|
| Cognito 初期設定 | - User Pool 作成<br>- SystemAdmin グループ作成<br>- IAM Role 定義<br>- SAML Identity Provider 設定<br>- User Pool Client 設定<br>- Identity Pool 作成 | ✅ **開発必要** | **インフラ構築**<br>- Cognito User Pool の作成<br>- SystemAdmin グループ作成（初期グループ）<br>- 管理者用/一般ユーザー用 IAM Role定義<br>- SAML Identity Provider（Entra ID）設定<br>- OAuth 2.0 設定（Authorization Code Flow）<br>- Identity Pool作成とRole Attachment設定<br>※ 部門別グループ（Admin-*, User-*）は動的作成 | インフラ（CDK）<br>Cognito | CDK<br>TypeScript | 8人日 |

---

## 📊 開発工数まとめ

| カテゴリ | 開発要素 | 使用技術 | 工数見積 |
|---------|---------|---------|---------|
| **管理画面UI（システム管理者）** | - 部門管理者登録<br>- メール入力フォーム<br>- ユースケース選択 | React, TypeScript, Material-UI | **10人日** |
| **管理画面UI（部門管理者）** | - ユーザー一覧表示<br>- 新規ユーザー追加<br>- Identity Pool 連携 | React, TypeScript, AWS SDK | **12人日** |
| **Lambda（AssignPendingGroup）** | - Cognito 存在確認<br>- S3 保存/直接追加分岐 | TypeScript, AWS SDK | **5人日** |
| **Lambda（PostAuthentication）** | - S3 読み取り<br>- グループ自動追加<br>- S3 削除 | TypeScript, AWS SDK | **5人日** |
| **インフラ（CDK）- S3** | - pending-assignments バケット<br>- ライフサイクルポリシー | CDK (TypeScript) | **2人日** |
| **インフラ（CDK）- API Gateway** | - エンドポイント定義<br>- Cognito Authorizer | CDK (TypeScript) | **3人日** |
| **インフラ（CDK）- Cognito** | - User Pool<br>- Groups 定義<br>- IAM Role マッピング<br>- SAML 連携 | CDK (TypeScript) | **8人日** |

**合計**: **約45人日**（管理者登録機能のみ、自動メール送信なし）

---

## 🔐 重要ポイント

| 項目 | 内容 |
|------|------|
| **テナント管理** | 部門 = Entra IDセキュリティグループ = テナントID<br>例: 営業部（SG-Sales）、マーケ部（SG-Marketing） |
| **Cognitoグループ** | 各部門に対して `Admin-{SecurityGroup}` と `User-{SecurityGroup}` を動的作成<br>例: Admin-SG-Sales, User-SG-Sales |
| **権限管理** | Cognito側で管理者/一般ユーザーを区別（Entra IDからは所属部門のみ受信） |
| **JWT自動セット** | ✅ Cognitoが `cognito:groups` に所属グループを自動的に含める（開発不要）<br>例: `{"cognito:groups": ["Admin-SG-Sales", "User-SG-Marketing"]}` |
| **管理者判定** | フロントエンドでJWTの `cognito:groups` から判定（API不要）<br>`groups.filter(g => g.startsWith('Admin-'))` |
| **Cognito招待メール** | ❌ **送られません**（Cognitoにユーザーを事前作成していない、SAML連携でパスワード不要） |
| **新しいパスワード** | ❌ **不要**（Entra IDのパスワードを使用） |
| **権限付与タイミング** | 初回ログイン時に自動（Post Authentication Trigger） |
| **DynamoDB** | ❌ **不使用**（S3 JSON ファイル方式） |
| **S3 ライフサイクル** | 30日で自動削除 |
| **マルチテナント対応** | 1ユーザが複数部門の管理者/一般ユーザーになることが可能 |

---

## 🏗️ AWSネイティブ機能（開発不要）

| 機能 | 使用サービス |
|------|------------|
| SAML 2.0 認証 | Cognito User Pool + Entra ID |
| JWT 発行・検証 | Cognito User Pool |
| OAuth 2.0 Authorization Code Flow | Cognito User Pool |
| グループメンバーシップ管理 | Cognito User Pool |
| IAM Role 一時認証情報発行 | Cognito Identity Pool |

---

## 📈 データフロー図

```
【ステップ0: 部門作成】
[システム管理者] → [React管理画面] → [Lambda: CreateTenant]
                                      ↓
                                [Cognito] グループ作成
                                - Admin-SG-Sales
                                - User-SG-Sales
                                      ↓
                                [IAM Role 紐付け]

【ステップ1: 部門管理者登録】
[システム管理者] → [React管理画面] → [API Gateway] → [Lambda: AssignPendingGroup]
                                           ↓
                                      [Cognito] AdminGetUser → UserNotFoundException
                                           ↓
                                      [S3] tanaka@isuzu.co.jp.json 保存
                                      {
                                        "email": "tanaka@isuzu.co.jp",
                                        "groups": ["Admin-SG-Sales"]
                                      }

【ステップ2: 初回ログイン】
[田中さん] → [Cognito Hosted UI] → [Entra ID SAML認証]
                                      ↓ セキュリティグループ（SG-Sales）を渡す
                                   [Cognito] ユーザー作成
                                      ↓
                                   [Lambda: PostAuthentication (Trigger)]
                                   S3読取 → AdminAddUserToGroup(Admin-SG-Sales) → S3削除
                                      ↓
                                   [JWT発行] ← Cognitoが自動セット
                                   {
                                     "cognito:groups": ["Admin-SG-Sales"],
                                     "email": "tanaka@isuzu.co.jp"
                                   }
                                      ↓
                                   [React管理画面]
                                   JWT解析 → Admin-* 判定 → 管理者メニュー表示
```

---

**作成者**: SI開発チーム | **最終更新**: 2025-12-11 | **バージョン**: 6.0（統合版・A4 1枚）
