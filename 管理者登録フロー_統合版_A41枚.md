# マルチテナント認証・認可システム - 管理者登録フロー（統合版）

**対象システム**: 全社共通LLMゲートウェイ | **想定規模**: 8,000名 × 100ユースケース | **作成日**: 2025-12-11

---

## 📋 推奨フロー

### システム管理者の操作
```
1. 管理画面で tanaka@isuzu.co.jp を Admin-RAG に登録
2. システムが S3 に JSON ファイル保存（s3://pending-assignments/tanaka@isuzu.co.jp.json）
3. 画面に「登録完了。ログインURLを共有してください」と表示
4. 業務メールで田中さんに通知（手動 or SES自動送信）
```

### 田中さん（部門管理者）の初回ログイン
```
1. メール受信 → URLクリック（https://llm-gateway.isuzu.co.jp）
2. 「Entra ID でログイン」ボタンをクリック
3. Entra ID で認証（既存アカウント・既存パスワード使用）
4. 【自動処理】Post Authentication Trigger 実行
   - S3 から JSON 読み取り → Admin-RAG グループに追加 → S3 削除
5. 管理画面が表示（管理者権限付与完了）
```

---

## 🔄 処理フロー詳細

### ステップ1: システム管理者が部門管理者を登録（未ログインユーザーの場合）

| No | 処理内容 | AWSサービス | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|----|---------|-----------|----------|---------|---------|---------|------|
| 1.1 | 管理者情報の入力と登録 | - | ✅ **開発必要** | **管理画面UI実装**<br>- メールアドレス入力フォーム作成<br>- 複数ユースケース選択UI（RAG/Translation/CodeGen）<br>- メール形式バリデーション<br>- 登録ボタンクリックイベント処理 | 管理画面UI<br>（システム管理者） | React<br>TypeScript<br>Material-UI | 3人日 |
| 1.2 | 部門管理者登録API実行 | API Gateway<br>Cognito Authorizer | ✅ **開発必要** | **インフラ構築**<br>- REST API エンドポイント定義<br>- Cognito Authorizer による JWT 検証設定<br>- SystemAdmin グループのみアクセス許可設定 | インフラ（CDK）<br>API Gateway | CDK<br>TypeScript | 3人日 |
| 1.3 | グループ割当（既存ユーザーは直接追加、未ログインはS3保存） | Lambda<br>Cognito User Pool<br>S3 | ✅ **開発必要** | **Lambda関数実装 + インフラ構築**<br>- Cognito User Pool でユーザー存在確認<br>- 既存ユーザー: 直接グループに追加<br>- 未ログインユーザー: S3に保留グループ情報をJSON形式で保存<br>- S3バケット作成と30日自動削除ポリシー設定 | Lambda<br>AssignPendingGroup<br>+<br>インフラ（CDK）<br>S3 | TypeScript<br>AWS SDK<br>+<br>CDK | 5人日<br>+<br>2人日 |
| 1.4 | 登録完了通知 | - | ✅ **開発必要** | **Lambda + フロントエンド実装**<br>- Lambda: JSON形式でステータス返却<br>- 画面: レスポンス受信後にトースト通知表示<br>- 「初回ログイン時に自動適用」メッセージ | Lambda + 管理画面UI | TypeScript<br>React | 含む |

**ステップ1 小計**: 管理画面UI 3人日 + API Gateway 3人日 + Lambda 5人日 + S3 2人日 = **13人日**

---

### ステップ2: 田中さんが初回ログイン

| No | 処理内容 | AWSサービス | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|----|---------|-----------|----------|---------|---------|---------|------|
| 2.1 | ログイン画面表示 | CloudFront<br>ALB, ECS<br>Cognito Hosted UI | ✅ / ❌ | **フロントエンド実装 + 設定**<br>- ログインページ作成とCognito Hosted UIへのリダイレクト処理<br>- Hosted UIのカスタマイズ（ロゴ・背景色） | 管理画面UI | React<br>TypeScript | 2人日 |
| 2.2 | SAML認証 | Entra ID (SAML) | ❌ **顧客側設定** | **設定作業のみ**<br>- Entra ID と Cognito 間のSAML連携設定<br>- メタデータXML交換<br>- 属性マッピング設定（email, name等） | - | - | - |
| 2.3 | ユーザー自動作成 | Cognito User Pool | ❌ **AWS標準** | AWS標準機能（開発不要） | - | - | - |
| 2.4 | 保留情報の取得 | Lambda<br>(Cognito Trigger) | ✅ **開発必要** | **Lambda関数実装 + インフラ構築**<br>- S3から保留ファイル取得（メールアドレスをキーに検索）<br>- JSONデータのパース<br>- NoSuchKey例外のハンドリング<br>- Cognito Triggerの設定 | Lambda<br>PostAuthentication | TypeScript<br>AWS SDK | 3人日 |
| 2.5 | グループ自動追加 | Cognito User Pool<br>S3 | ✅ **開発必要** | **Lambda関数実装**<br>- 取得したグループリストをループ処理<br>- 各グループにユーザーを追加<br>- 処理完了後にS3ファイルを削除<br>- エラーログ出力 | Lambda<br>PostAuthentication | TypeScript<br>AWS SDK | 2人日 |
| 2.6 | JWT発行 | Cognito User Pool | ❌ **AWS標準** | AWS標準機能（開発不要） | - | - | - |
| 2.7 | トークン取得と画面表示 | - | ✅ **開発必要** | **フロントエンド実装**<br>- コールバックURLでAuthorization Code受信<br>- Token エンドポイントへPOSTリクエスト<br>- 取得したToken をLocalStorageに保存<br>- ホーム画面へリダイレクト処理 | 管理画面UI | React<br>TypeScript | 3人日 |

**ステップ2 小計**: 管理画面UI 5人日 + Lambda (PostAuthentication) 5人日 = **10人日**

---

### ステップ3: 部門管理者が一般ユーザーを登録

| No | 処理内容 | AWSサービス | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|----|---------|-----------|----------|---------|---------|---------|------|
| 3.1 | ユーザー管理画面 | Cognito Identity Pool<br>Cognito User Pool | ✅ **開発必要** | **フロントエンド実装**<br>- 「ユーザー管理」メニューの表示制御（管理者のみ）<br>- Identity Pool から一時認証情報を取得<br>- AdminListUsersInGroup API でユーザー一覧取得<br>- ユーザー一覧のテーブル表示UI<br>- ページネーション実装 | 管理画面UI<br>（部門管理者） | React<br>TypeScript<br>AWS SDK | 7人日 |
| 3.2 | ユーザー追加 | API Gateway<br>Lambda | ✅ **開発必要** | **フロントエンド実装**<br>- メールアドレス入力フォーム<br>- バリデーション処理<br>- API呼び出し（既存AssignPendingGroup再利用）<br>- 追加完了後のユーザー一覧再読み込み | 管理画面UI<br>（部門管理者） | React<br>TypeScript | 5人日 |

**ステップ3 小計**: 管理画面UI（部門管理者） **12人日**

---

### インフラ（Cognito設定）

| 項目 | 内容 | SI開発要否 | 開発内容 | カテゴリ | 使用技術 | 工数 |
|------|------|----------|---------|---------|---------|------|
| Cognito 設定 | - User Pool 作成<br>- Groups 定義（SystemAdmin, Admin-*, User-*）<br>- IAM Role マッピング<br>- SAML Identity Provider 設定<br>- User Pool Client 設定<br>- Identity Pool 作成 | ✅ **開発必要** | **インフラ構築**<br>- Cognito User Pool の作成<br>- 全ユースケース分のGroups作成（100ユースケース × 2（Admin, User））<br>- 各GroupへのIAM Role紐付け<br>- SAML Identity Provider（Entra ID）設定<br>- OAuth 2.0 設定（Authorization Code Flow）<br>- Identity Pool作成とRole Attachment設定 | インフラ（CDK）<br>Cognito | CDK<br>TypeScript | 8人日 |

---

## 📊 開発工数まとめ

| カテゴリ | 開発要素 | 使用技術 | 工数見積 |
|---------|---------|---------|---------|
| **管理画面UI（システム管理者）** | - 部門管理者登録<br>- メール入力フォーム<br>- ユースケース選択 | React, TypeScript, Material-UI | **10人日** |
| **管理画面UI（部門管理者）** | - ユーザー一覧表示<br>- 新規ユーザー追加<br>- Identity Pool 連携 | React, TypeScript, AWS SDK | **12人日** |
| **Lambda（AssignPendingGroup）** | - Cognito 存在確認<br>- S3 保存/直接追加分岐 | TypeScript, AWS SDK | **5人日** |
| **Lambda（PostAuthentication）** | - S3 読み取り<br>- グループ自動追加<br>- S3 削除 | TypeScript, AWS SDK | **5人日** |
| **インフラ（CDK）- S3** | - pending-assignments バケット<br>- ライフサイクルポリシー | CDK (TypeScript) | **2人日** |
| **インフラ（CDK）- API Gateway** | - エンドポイント定義<br>- Cognito Authorizer | CDK (TypeScript) | **3人日** |
| **インフラ（CDK）- Cognito** | - User Pool<br>- Groups 定義<br>- IAM Role マッピング<br>- SAML 連携 | CDK (TypeScript) | **8人日** |

**合計**: **約45人日**（管理者登録機能のみ、自動メール送信なし）

---

## 🔐 重要ポイント

| 項目 | 内容 |
|------|------|
| **Cognito招待メール** | ❌ **送られません**（Cognitoにユーザーを事前作成していない、SAML連携でパスワード不要） |
| **新しいパスワード** | ❌ **不要**（Entra IDのパスワードを使用） |
| **権限付与タイミング** | 初回ログイン時に自動（Post Authentication Trigger） |
| **DynamoDB** | ❌ **不使用**（S3 JSON ファイル方式） |
| **S3 ライフサイクル** | 30日で自動削除 |

---

## 🏗️ AWSネイティブ機能（開発不要）

| 機能 | 使用サービス |
|------|------------|
| SAML 2.0 認証 | Cognito User Pool + Entra ID |
| JWT 発行・検証 | Cognito User Pool |
| OAuth 2.0 Authorization Code Flow | Cognito User Pool |
| グループメンバーシップ管理 | Cognito User Pool |
| IAM Role 一時認証情報発行 | Cognito Identity Pool |

---

## 📈 データフロー図

```
[システム管理者] → [React管理画面] → [API Gateway] → [Lambda: AssignPendingGroup]
                                           ↓
                                      [Cognito] AdminGetUser → UserNotFoundException
                                           ↓
                                      [S3] tanaka@isuzu.co.jp.json 保存

[田中さん] → [Cognito Hosted UI] → [Entra ID SAML] → [Cognito] ユーザー作成
                                           ↓
                                      [Lambda: PostAuthentication (Trigger)]
                                      S3読取 → AdminAddUserToGroup → S3削除
                                           ↓
                                      [JWT] cognito:groups: ["Admin-RAG"]
                                           ↓
                                      [React管理画面] 権限付与完了
```

---

**作成者**: SI開発チーム | **最終更新**: 2025-12-11 | **バージョン**: 6.0（統合版・A4 1枚）
